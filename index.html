<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>é€²éšæ—…éŠåˆ†å¸³èˆ‡æ¸…ç®—å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (v9 compat via CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* è¨­å®š Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .appearance-none { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        
        /* Chip æ¨£å¼ */
        .chip-base { 
            padding: 8px 16px; border-radius: 9999px; cursor: pointer; transition: all 0.15s ease-in-out; 
            font-weight: 500; font-size: 0.875rem; border: 2px solid; user-select: none; white-space: nowrap;
        }
        .chip-inactive { background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db; }
        .chip-active { background-color: #4f46e5; color: #ffffff; border-color: #4f46e5; }
        .chip-category-active { background-color: #059669; color: #ffffff; border-color: #059669; }
        .chip-category-inactive { background-color: #d1fae5; color: #065f46; border-color: #a7f3d0; }
        
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        /* å¹£åˆ¥ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .currency-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 7l3 3 3-3' stroke='%234B5563' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        /* ---- Mobile consistency ---- */
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        html, body { width: 100%; overflow-x: hidden; }
        input, select, textarea, button { font-size: 16px; }
        .container-full { width: 100%; max-width: 100%; min-width: 0; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-8">

        <header class="text-center pb-4">
            <h1 class="text-4xl font-extrabold text-gray-800">ğŸ’° è¨˜å¸³å·¥å…·</h1>
            <p class="text-gray-500 mt-2" id="current-trip-display">è¡Œç¨‹è¼‰å…¥ä¸­...</p>
        </header>
        
        <!-- è¨Šæ¯å½ˆçª— (ç”¨ä¾†å–ä»£ alert) -->
        <div id="message-box" class="fixed inset-x-0 top-0 z-50 p-4 hidden">
            <div id="message-content" class="max-w-sm mx-auto bg-yellow-500 text-white p-3 rounded-lg shadow-xl text-center font-medium">
                <!-- è¨Šæ¯å…§å®¹ -->
            </div>
        </div>

        <!-- ç¢ºèªå°è©±æ¡† -->
        <div id="confirm-dialog" class="fixed inset-0 z-[100] hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 pointer-events-auto">
                <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4">åˆªé™¤æˆå“¡ç¢ºèª</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div class="space-y-3">
                    <button type="button" id="confirm-keep-expenses" class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        ä¿ç•™è¨˜éŒ„
                    </button>
                    <button type="button" id="confirm-delete-expenses" class="w-full py-3 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        åˆªé™¤è¨˜éŒ„
                    </button>
                    <button type="button" id="confirm-cancel" class="w-full py-2 px-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- 1. è¨˜éŒ„æ”¯å‡ºå¡ç‰‡ -->
        <div id="expense-input-card" class="bg-white card rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">è¨˜éŒ„æ”¯å‡º</h2>
            
            <div class="space-y-4">
                <!-- æ”¯å‡ºé …ç›® -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®æè¿°</label>
                    <input type="text" id="expense-description" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Šè²»"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- é¡åˆ¥é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ”¯å‡ºé¡åˆ¥</label>
                    <div id="category-chips" class="flex flex-wrap gap-2">
                        <!-- Categories will be rendered here -->
                    </div>
                </div>
                
                <!-- é‡‘é¡èˆ‡å¹£åˆ¥ -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label>
                        <input type="number" id="expense-amount" placeholder="0" min="0" step="1" inputmode="decimal"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 appearance-none">
                    </div>
                    <div class="w-full sm:w-24">
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¹£åˆ¥</label>
                        <select id="expense-currency" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 appearance-none cursor-pointer currency-select">
                            <option value="TWD">TWD</option>
                            <option value="USD">USD</option>
                            <option value="JPY">JPY</option>
                            <option value="KRW">KRW</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>
                
                <!-- ä»˜æ¬¾äºº -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">èª°ä»˜çš„éŒ¢ï¼Ÿ</label>
                    <div id="payer-chips" class="flex flex-wrap gap-2">
                        <p class="text-gray-400 text-sm italic p-2">è«‹å…ˆæ–°å¢æˆå“¡</p>
                    </div>
                </div>

                <!-- åˆ†æ”¤äºº -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">èª°åƒèˆ‡åˆ†æ”¤ï¼Ÿ</label>
                    <div id="share-chips" class="flex flex-wrap gap-2">
                        <p class="text-gray-400 text-sm italic p-2">è«‹å…ˆæ–°å¢æˆå“¡</p>
                    </div>
                    <div class="flex items-center space-x-4 mt-2">
                        <button id="select-all-sharers" class="text-indigo-600 text-sm hover:text-indigo-800 transition-colors">å…¨é¸ / å–æ¶ˆå…¨é¸</button>
                        <button id="custom-split-btn" class="text-blue-600 text-sm hover:text-blue-800 transition-colors hidden">è‡ªå®šç¾©åˆ†æ”¤é‡‘é¡</button>
                    </div>
                    
                    <!-- è‡ªå®šç¾©åˆ†æ”¤é‡‘é¡å€åŸŸ -->
                    <div id="custom-split-section" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                        <h4 class="text-sm font-medium text-blue-800 mb-3">è‡ªå®šç¾©åˆ†æ”¤é‡‘é¡</h4>
                        <div id="custom-split-inputs" class="space-y-2">
                            <!-- è‡ªå®šç¾©åˆ†æ”¤è¼¸å…¥æœƒè¢« JavaScript å¡«å…… -->
                        </div>
                        <div class="mt-3 flex items-center justify-between">
                            <span id="split-total" class="text-sm font-medium text-blue-700">ç¸½è¨ˆ: 0</span>
                            <button id="apply-custom-split" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors hidden">
                                å¥—ç”¨åˆ†æ”¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <button id="add-expense-btn"
                    class="mt-6 w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md disabled:bg-gray-400">
                æ–°å¢æ”¯å‡º
            </button>
        </div>


        <!-- 2. çµç®—ç¸½è¦½å¡ç‰‡ -->
        <div id="settlement-overview-card" class="bg-indigo-700 card rounded-xl p-6 shadow-xl text-white">
            <h2 class="text-2xl font-bold mb-4 text-indigo-100">ğŸ’° çµç®—ç¸½è¦½</h2>
            <div class="flex flex-wrap gap-3 mb-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-indigo-600 text-sm">
                  <span id="trip-total-label">è¡Œç¨‹ç¸½èŠ±è²» (TWD):</span>
                  <strong class="ml-2" id="trip-total-twd">0</strong>
                </span>
            </div>
            <div id="should-spend-badges" class="flex flex-wrap gap-2 mb-4"></div>
            
            <div class="grid grid-cols-4 text-sm font-medium mb-2 pb-2 border-b border-indigo-400/50">
                <span>æˆå“¡</span>
                <span class="text-center">å¯¦éš›æ”¯å‡º (TWD)</span>
                <span class="text-center">ç†è«–æ”¯å‡º (TWD)</span>
                <span class="text-center">æ·¨é¡ (TWD)</span>
            </div>

            <div id="settlement-list" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                <p class="text-indigo-300 text-sm text-center">è«‹æ–°å¢æˆå“¡èˆ‡æ”¯å‡ºä¾†è¨ˆç®—</p>
            </div>
        </div>
        
        <!-- 3. æœ€ä½³æ¸…ç®—è·¯å¾‘å¡ç‰‡ -->
        <div id="settlement-path-card" class="bg-gray-800 card rounded-xl p-6 shadow-xl text-white">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">âš¡ æœ€ä½³æ¸…ç®—è·¯å¾‘</h2>
            <div id="settlement-path" class="space-y-3">
                <p class="text-gray-400 text-sm text-center">æ¸…ç®—è·¯å¾‘æœƒåœ¨é€™è£¡é¡¯ç¤º</p>
            </div>
        </div>

        <!-- 4. æˆå“¡ç®¡ç†å¡ç‰‡ (è¦–ç‚ºè¨­å®š) - æ”¯æ´æ”¶åˆåŠŸèƒ½ -->
        <div id="member-management-card" class="bg-white card rounded-xl p-6 shadow-lg min-w-0 break-words container-full">
            <!-- Clickable Header Button -->
            <button id="toggle-settings-btn" class="w-full flex justify-between items-center text-left -mt-2">
                <h2 class="text-2xl font-bold text-gray-700 flex items-center">
                    æˆå“¡ç®¡ç†èˆ‡è¨­å®š
                    <span class="ml-3 text-sm font-medium text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full" id="member-count">0 äºº</span>
                </h2>
                <!-- Arrow Icon (åˆå§‹ç‹€æ…‹ï¼šæ”¶åˆï¼Œç®­é ­æœä¸‹/å³) -->
                <svg id="toggle-icon" class="w-6 h-6 text-gray-500 transition-transform duration-300 transform rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <!-- Collapsible Content Wrapper (åˆå§‹ç‹€æ…‹ï¼šmax-h-0 æ”¶åˆ) -->
            <div id="settings-content" class="transition-all duration-300 max-h-0 overflow-y-auto overflow-x-visible w-full px-2 sm:px-3">
                
                <!-- æˆå“¡æ–°å¢ -->
                <div class="flex flex-col sm:flex-row flex-wrap gap-2 mb-4 pt-4">
                    <input type="text" id="member-name-input" placeholder="è¼¸å…¥æˆå“¡åç¨±..."
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-sm" maxlength="15">
                    <button id="add-member-btn"
                            class="w-full sm:w-auto px-5 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md disabled:bg-gray-400">
                        æ–°å¢
                    </button>
                </div>
                <div id="member-list" class="flex flex-wrap gap-2 min-h-[3rem] p-2 border border-dashed border-gray-200 rounded-lg mb-6">
                    <!-- æˆå“¡æ™¶ç‰‡æœƒè¢« JavaScript å¡«å…… -->
                    <p class="text-gray-400 text-sm italic">è«‹æ–°å¢æˆå“¡...</p>
                </div>
                
                <!-- è¡Œç¨‹ç®¡ç† -->
                <div class="mt-6 border-t pt-4 min-w-0 break-words">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">è¡Œç¨‹ç®¡ç†</h3>
                    
                    <!-- ç•¶å‰è¡Œç¨‹é¡¯ç¤º -->
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-blue-800">ç•¶å‰è¡Œç¨‹</p>
                                <p class="text-lg font-bold text-blue-900" id="current-trip-name">é è¨­è¡Œç¨‹</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-blue-600" id="current-trip-stats">0 ç­†æ”¯å‡º</p>
                            </div>
                        </div>
                        <!-- æ­·å²è¡Œç¨‹ä¸‹æ‹‰é¸å–® -->
                        <div class="mt-3">
                            <label for="trip-select" class="text-xs text-blue-700 mr-2">é¸æ“‡æ­·å²è¡Œç¨‹</label>
                            <select id="trip-select" class="mt-1 w-full md:w-auto p-2 border border-blue-200 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                    </div>

                    <!-- æ–°å¢è¡Œç¨‹ -->
                    <div class="flex flex-col sm:flex-row flex-wrap gap-2 mb-4">
                        <input type="text" id="trip-name-input" placeholder="è¼¸å…¥è¡Œç¨‹åç¨±..."
                               class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-sm" maxlength="20">
                        <button id="add-trip-btn"
                                class="w-full sm:w-auto px-5 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:bg-gray-400">
                            æ–°å¢
                        </button>
                    </div>

                    <!-- è¡Œç¨‹åˆ—è¡¨ -->
                    <div id="trip-list" class="space-y-2 max-h-32 overflow-y-auto pr-1">
                        <!-- è¡Œç¨‹åˆ—è¡¨æœƒè¢« JavaScript å¡«å…… -->
                    </div>
                </div>

                <!-- è³‡æ–™åŒ¯å…¥ï¼åŒ¯å‡º -->
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">è³‡æ–™å‚™ä»½èˆ‡è½‰ç§»</h3>
                    
                    <div class="mt-3">
                        <button id="export-excel-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                            Export current trip (Excel)
                        </button>
                        <p class="text-xs text-gray-500 mt-1">Export all expenses of the current trip to .xlsx</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        æé†’ï¼šLocalStorage åªå„²å­˜åœ¨ã€Œé€™å°è£ç½®ï¼é€™å€‹ç€è¦½å™¨ï¼é€™å€‹ç¶²å€ä¾†æºã€ã€‚è‹¥è¦è·¨è£ç½®ä½¿ç”¨ï¼Œè«‹åœ¨æ­¤åŒ¯å‡º JSONï¼Œå†åˆ°å¦ä¸€å°è£ç½®åŒ¯å…¥ã€‚
                    </p>
                </div>

                <!-- åŒ¯ç‡è¨­å®š -->
                <div class="mt-6 border-t pt-4">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">åŒ¯ç‡è¨­å®š (åŸºæº–å¹£åˆ¥: TWD)</h3>
                    
                    <p class="text-gray-500 text-xs mb-3">è«‹æ‰‹å‹•è¼¸å…¥æ‚¨æ‰€éœ€çš„åƒè€ƒåŒ¯ç‡ï¼ŒåŸºæº–å¹£åˆ¥ç‚º TWDã€‚</p>

                    <div class="mb-2 flex flex-wrap items-center gap-2">
                        <button id="refresh-rates-btn" class="px-3 py-1 bg-gray-700 text-white rounded">Refresh rates</button>
                        <span id="rates-updated-at" class="text-xs text-gray-500"></span>
                    </div>
                    <div class="mb-2 flex flex-wrap items-center gap-2">
                        <input type="text" id="new-currency-input" placeholder="Add currency (e.g. SGD)" maxlength="5" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <button id="add-currency-btn" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">Add</button>
                    </div>

                    <!-- åŒ¯ç‡è¼¸å…¥å€ -->
                    <div id="exchange-rate-inputs" class="space-y-3 text-sm">
                        <!-- åŒ¯ç‡è¼¸å…¥æœƒè¢« JavaScript å¡«å…… -->
                    </div>
                    <p class="text-xs text-gray-400 mt-2" id="rate-last-updated"></p>
                </div>
                <div class="mt-6 border-t pt-4">
                  <h3 class="text-xl font-bold text-gray-700 mb-3">é›²ç«¯åŒæ­¥</h3>
                  <div class="flex flex-wrap items-center gap-2 mb-2">
                    <input id="trip-code-input" type="text" placeholder="è¼¸å…¥å…±äº«ä»£ç¢¼" class="flex-1 min-w-0 w-full sm:w-auto p-2 border border-gray-300 rounded-lg text-sm" />
                    <button id="cloud-link" class="w-full sm:w-auto px-3 py-1 bg-indigo-600 text-white rounded text-sm">Link</button>
                    <button id="cloud-cancel" class="w-full sm:w-auto px-3 py-1 bg-gray-600 text-white rounded text-sm">Cancel Sync</button>
                  </div>
                  <p class="text-xs text-gray-500" id="cloud-status">æœªåŒæ­¥</p>
                </div>
            </div>
        </div>

        <!-- 5. æ”¯å‡ºåˆ—è¡¨å¡ç‰‡ (è¦–ç‚ºç´€éŒ„ç€è¦½) -->
        <div id="expenses-list-card" class="bg-white card rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">æ‰€æœ‰æ”¯å‡º (ç´€éŒ„ç€è¦½)</h2>
            <ul id="expenses-list" class="space-y-3 max-h-96 overflow-y-auto pr-1">
                <li class="text-gray-400 italic text-sm">å°šç„¡æ”¯å‡ºè¨˜éŒ„...</li>
            </ul>
        </div>


    </div>

    <script>
        // Firebase init (guarded)
        const firebaseConfig = {
        apiKey: "AIzaSyAUHmk0lHiUhLMGPy-0c9EWMgVbItYQo6U",
        authDomain: "billshare-c97ba.firebaseapp.com",
        projectId: "billshare-c97ba",
        storageBucket: "billshare-c97ba.firebasestorage.app",
        messagingSenderId: "1097608833511",
        appId: "1:1097608833511:web:d7138a264676993fc5f542"
        };

        // Initial cloud status on page load
        (function(){
          const st = document.getElementById('cloud-status');
          if (st) st.textContent = 'æœªåŒæ­¥ï¼ˆå¾…é€£ç·šï¼‰';
        })();

        let db = null;
        try {
          if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY" ||
              !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.warn("Firebase config is not set. Cloud features will be disabled.");
          } else {
            if (window.firebase && !firebase.apps.length) {
              firebase.initializeApp(firebaseConfig);
            }
            db = window.firebase ? firebase.firestore() : null;
            if (db && db.enablePersistence) { try { db.enablePersistence(); } catch(e) {} }
          }
        } catch (e) {
          console.error("Firebase init failed:", e);
          db = null;
        }

        // Surface status if db not ready
        (function(){
          if (!db) {
            const st = document.getElementById('cloud-status');
            if (st) st.textContent = 'æœªåŒæ­¥ï¼ˆå°šæœªè¨­å®š Firebaseï¼‰';
          }
        })();

        // --- æ ¸å¿ƒè³‡æ–™çµæ§‹ ---
        let trips = []; // è¡Œç¨‹åˆ—è¡¨
        let lastEditedTripId = null;   // æ–°å¢ï¼šæœ€å¾Œç·¨è¼¯çš„è¡Œç¨‹ ID
        let currentTripId = null; // ç•¶å‰é¸ä¸­çš„è¡Œç¨‹ ID
        let members = [];
        let expenses = [];
        let currentPayer = null;
        let currentSharers = [];
        let currentCategory = 'é£Ÿ'; // é è¨­é¡åˆ¥

        // Make header subtitle reflect current trip name (global, used by multiple functions)
        function updateHeaderTripName() {
          const tripDisplayEl = document.getElementById('current-trip-display');
          if (!tripDisplayEl) return;
          const t = trips.find(x => x.id === currentTripId);
          tripDisplayEl.textContent = t ? t.name : 'å°šæœªé¸æ“‡è¡Œç¨‹';
        }

        // Cloud sync state
        let syncedTripId = null;
        function setCloudStatus(text) {
          const el = document.getElementById('cloud-status');
          if (el) el.textContent = text;
        }
        let isSyncingToCloud = false; // prevents write loop
        let isUpdatingFromCloud = false; // prevents read/write race
        let unsubscribeTrip = null;   // to detach trip-level listener
        let justHydratedFromCloud = false; // skip one mirror after a fresh hydrate

        // ---- Device identity (stable per browser) ----
        const DEVICE_ID_KEY = 'travel_device_id';
        const DEVICE_NAME_KEY = 'travel_device_name';

        function genId(len = 12) {
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
          let out = ''; for (let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
          return out;
        }
        function detectDeviceBaseName() {
          const ua = navigator.userAgent || '';
          if (/iPhone|iPad|iPod/i.test(ua)) return 'iOS';
          if (/Android/i.test(ua)) return 'Android';
          if (/Macintosh|Mac OS X/i.test(ua)) return 'Mac';
          if (/Windows/i.test(ua)) return 'Windows';
          if (/Linux/i.test(ua)) return 'Linux';
          return 'Web';
        }
        function ensureDeviceIdentity() {
          let id = localStorage.getItem(DEVICE_ID_KEY);
          if (!id) { id = genId(16); localStorage.setItem(DEVICE_ID_KEY, id); }
          let name = localStorage.getItem(DEVICE_NAME_KEY);
          if (!name) {
            const base = detectDeviceBaseName();
            const suffix = id.slice(-4);
            name = `${base}-${suffix}`;
            localStorage.setItem(DEVICE_NAME_KEY, name);
          }
          return { id, name };
        }
        let DEVICE = null;

        function getCurrentTripName() {
          const t = trips.find(tt => tt.id === currentTripId);
          return (t && t.name) ? t.name : 'æœªå‘½åè¡Œç¨‹';
        }

        // Persist linked trip id across reloads
        function getSyncedId() { return localStorage.getItem('travel_synced_trip_id') || ''; }
        function setSyncedId(v) { if (v) localStorage.setItem('travel_synced_trip_id', v); else localStorage.removeItem('travel_synced_trip_id'); }

        // Helper: validate trip code pattern
        function looksLikeTripCode(s) {
          return typeof s === 'string' && s.trim().length >= 16;
        }

        // Ensure UI is viewing the synced trip
        function ensureViewingSyncedTrip() {
          try {
            if (syncedTripId && currentTripId !== syncedTripId) {
              if (!trips.some(t => t.id === syncedTripId)) {
                trips.push({
                  id: syncedTripId,
                  name: 'é›²ç«¯è¡Œç¨‹',
                  createdAt: new Date().toISOString(),
                  members: Array.isArray(members) ? [...members] : []
                });
                localStorage.setItem('travel_trips', JSON.stringify(trips));
              }
              currentTripId = syncedTripId;
              localStorage.setItem('travel_current_trip_id', currentTripId);
              switchToTrip(currentTripId);
            }
          } catch (e) {
            console.warn('ensureViewingSyncedTrip failed:', e);
          }
        }

        // Auto resume cloud sync on load (URL ?code has priority)
        async function autoResumeCloudOnLoad() {
          try {
            if (!db) db = await ensureDbReady();
          } catch (e) {
            console.warn('ensureDbReady failed, skip auto resume:', e);
            return;
          }
          const url = new URL(window.location.href);
          const urlCode = (url.searchParams.get('code') || '').trim();
          const prevCode = (getSyncedId() || '').trim();
          const code = urlCode || prevCode;
          if (!code || !looksLikeTripCode(code)) return;
          try {
            if (syncedTripId === code) {
              await subscribeTrip(code);
              setCloudStatus('å·²åŒæ­¥ï¼š' + code);
              const input = document.getElementById('trip-code-input');
              if (input) input.value = code;
              return;
            }
            const hasAnyLocal = !!localStorage.getItem('travel_trips') || !!localStorage.getItem('travel_expenses');
            if (!hasAnyLocal) {
              await hydrateLocalFromCloud(code);
              syncedTripId = code;
              setSyncedId(code);
              setCloudStatus('å·²åŒæ­¥ï¼š' + code);
              await subscribeTrip(code);
              ensureViewingSyncedTrip();
            } else {
              syncedTripId = code;
              setSyncedId(code);
              setCloudStatus('å·²åŒæ­¥ï¼š' + code);
              await subscribeTrip(code);
              ensureViewingSyncedTrip();
            }
            const input2 = document.getElementById('trip-code-input');
            if (input2) input2.value = code;
          } catch(e) {
            console.warn('autoResumeCloudOnLoad failed:', e);
          }
        }

        // Ensure Firestore is initialized before use
        async function ensureDbReady() {
          if (window.db) return window.db;
          if (window.firebase && firebase.firestore) {
            if (!firebase.apps.length) {
              firebase.initializeApp(firebaseConfig);
            }
            window.db = firebase.firestore();
            try { if (window.db.enablePersistence) await window.db.enablePersistence(); } catch (e) {}
            const st = document.getElementById('cloud-status');
            if (st) st.textContent = 'æœªåŒæ­¥ï¼ˆå¯ç”¨ï¼‰';
            return window.db;
          }
          throw new Error('Firebase SDK present but Firestore not available');
        }

        // åŒ¯ç‡è³‡æ–™çµæ§‹ (å¯è®Šå‹•)
        let defaultExchangeRates = {
            'TWD': 1,
            'USD': 30.5,
            'JPY': 0.21,
            'KRW': 0.024,
            'EUR': 34.0,
            'CNY': 4.5,
        };
        let exchangeRates = { ...defaultExchangeRates };
        const categories = ['é£Ÿ', 'è¡£', 'ä½', 'è¡Œ', 'è³¼', 'å¨›', 'å…¶ä»–'];
        let rateLastUpdated = 'æœªæ›¾æ‰‹å‹•æ›´æ–°';

        // --- DOM å…ƒç´ è®Šæ•¸å®£å‘Š ---
        let memberNameInput, addMemberBtn, memberListEl, memberCountEl;
        let expenseDescriptionInput, expenseAmountInput, expenseCurrencySelect, categoryChipsEl;
        let payerChipsEl, shareChipsEl, selectAllSharersBtn, addExpenseBtn;
        let expensesListEl, settlementListEl, settlementPathEl;
        let exchangeRateInputsEl, rateLastUpdatedEl; // ç§»é™¤äº† fetchRatesBtn
        let messageBoxEl, messageContentEl; // è¨Šæ¯æç¤º
        
        // æ–°å¢è¨­å®šå€å¡Šæ”¶åˆç›¸é—œè®Šæ•¸
        let settingsContentEl, toggleSettingsBtn, toggleIconEl;
        let isSettingsOpen = true; // åˆå§‹ç‹€æ…‹: æ”¶åˆ

        // ç¢ºèªå°è©±æ¡†ç›¸é—œè®Šæ•¸
        let confirmDialogEl, confirmTitleEl, confirmMessageEl, confirmCancelBtn, confirmKeepExpensesBtn, confirmDeleteExpensesBtn;
        let pendingMemberName = null; // å„²å­˜å¾…åˆªé™¤çš„æˆå“¡åç¨±
        let confirmKeepHandler = null; // é€šç”¨ç¢ºèª-ä¿ç•™ è™•ç†å™¨
        let confirmDeleteHandler = null; // é€šç”¨ç¢ºèª-åˆªé™¤ è™•ç†å™¨

        // è¡Œç¨‹ç®¡ç†ç›¸é—œè®Šæ•¸
        let tripNameInput, addTripBtn, tripListEl, currentTripNameEl, currentTripStatsEl, tripSelectEl;


        // è‡ªå®šç¾©åˆ†æ”¤ç›¸é—œè®Šæ•¸
        let customSplitBtn, customSplitSection, customSplitInputs, splitTotalEl, applyCustomSplitBtn;
        let customSplitAmounts = {}; // å„²å­˜è‡ªå®šç¾©åˆ†æ”¤é‡‘é¡
        let isCustomSplitMode = false; // æ˜¯å¦ç‚ºè‡ªå®šç¾©åˆ†æ”¤æ¨¡å¼

        // --- Local Storage é‚è¼¯ ---

        /**
         * è®€å–æ‰€æœ‰è³‡æ–™ (è¡Œç¨‹, æˆå“¡, æ”¯å‡º, åŒ¯ç‡)
         */
        function loadAllData() {
            try {
                console.log('é–‹å§‹è¼‰å…¥è³‡æ–™...');
                // å¾ Local Storage è®€å–å„²å­˜çš„è³‡æ–™
                const storedTrips = localStorage.getItem('travel_trips');
                const storedCurrentTripId = localStorage.getItem('travel_current_trip_id');
                const storedMembers = localStorage.getItem('travel_members');
                const storedExpenses = localStorage.getItem('travel_expenses');
                const storedRates = localStorage.getItem('travel_rates');
                const storedLastUpdated = localStorage.getItem('travel_rate_update');
                const storedLastEditedTripId = localStorage.getItem('travel_last_edited_trip_id'); // æ–°å¢

                console.log('LocalStorage è³‡æ–™:', {
                    trips: storedTrips ? JSON.parse(storedTrips) : null,
                    currentTripId: storedCurrentTripId,
                    members: storedMembers ? JSON.parse(storedMembers) : null,
                    expenses: storedExpenses ? JSON.parse(storedExpenses) : null,
                    lastEditedTripId: storedLastEditedTripId
                });

                // è¼‰å…¥è¡Œç¨‹è³‡æ–™
                if (storedTrips) {
                    trips = JSON.parse(storedTrips);
                    console.log('è¼‰å…¥è¡Œç¨‹è³‡æ–™:', trips);
                } else {
                    // å¦‚æœæ²’æœ‰è¡Œç¨‹è³‡æ–™ï¼Œå‰µå»ºç©ºé™£åˆ—
                    trips = [];
                    console.log('æ²’æœ‰è¡Œç¨‹è³‡æ–™ï¼Œå‰µå»ºç©ºé™£åˆ—');
                }

                // ä¾å„ªå…ˆé †åºæ±ºå®šç•¶å‰è¡Œç¨‹ï¼šæœ€å¾Œç·¨è¼¯ > æ—¢å­˜ current > ä¾æ™‚é–“æœ€æ–° > å¦å‰‡ null
                if (storedLastEditedTripId && trips.some(t => t.id === storedLastEditedTripId)) {
                    currentTripId = storedLastEditedTripId;
                    console.log('è¼‰å…¥æœ€å¾Œç·¨è¼¯çš„è¡Œç¨‹:', storedLastEditedTripId);
                } else if (storedCurrentTripId && trips.some(t => t.id === storedCurrentTripId)) {
                    currentTripId = storedCurrentTripId;
                    console.log('è¼‰å…¥å„²å­˜çš„ç•¶å‰è¡Œç¨‹:', storedCurrentTripId);
                } else if (trips.length > 0) {
                    const sorted = [...trips].sort((a, b) =>
                        new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0)
                    );
                    currentTripId = sorted[0].id;
                    console.log('è¼‰å…¥æœ€æ–°è¡Œç¨‹:', currentTripId);
                } else {
                    currentTripId = null;
                    console.log('æ²’æœ‰è¡Œç¨‹å¯è¼‰å…¥');
                }


                // è®€å–èˆŠç‰ˆå…¨åŸŸ membersï¼ˆç›¸å®¹æ€§ï¼‰
                let legacyMembers = null;
                if (storedMembers) legacyMembers = JSON.parse(storedMembers);
                if (storedExpenses) expenses = JSON.parse(storedExpenses);
                // è®€å–åŒ¯ç‡æ™‚ï¼Œéœ€ç¢ºä¿ TWD ä»åœ¨
                if (storedRates) {
                    const loadedRates = JSON.parse(storedRates);
                    exchangeRates = { 'TWD': 1, ...loadedRates };
                }
                if (storedLastUpdated) rateLastUpdated = storedLastUpdated;
                
                // å°‡æˆå“¡ç¶å®šåˆ°ç›®å‰è¡Œç¨‹ï¼ˆæ¯å€‹è¡Œç¨‹å„è‡ªæœ‰ membersï¼‰
                const currentTrip = trips.find(t => t.id === currentTripId);
                if (currentTrip) {
                    if (Array.isArray(currentTrip.members)) {
                        members = [...currentTrip.members];
                        console.log('è¼‰å…¥è¡Œç¨‹æˆå“¡:', currentTrip.name, 'æˆå“¡æ•¸:', members.length);
                    } else if (Array.isArray(legacyMembers)) {
                        // é¦–æ¬¡å‡ç´šï¼šå¾èˆŠç‰ˆå…¨åŸŸ members ç§»å…¥ç›®å‰è¡Œç¨‹
                        currentTrip.members = [...legacyMembers];
                        members = [...legacyMembers];
                        console.log('å¾èˆŠç‰ˆè¼‰å…¥æˆå“¡åˆ°è¡Œç¨‹:', currentTrip.name, 'æˆå“¡æ•¸:', members.length);
                    } else {
                        currentTrip.members = [];
                        members = [];
                        console.log('è¡Œç¨‹ç„¡æˆå“¡:', currentTrip.name);
                    }
                } else {
                    members = Array.isArray(legacyMembers) ? [...legacyMembers] : [];
                    console.log('ç„¡ç•¶å‰è¡Œç¨‹ï¼Œè¼‰å…¥èˆŠç‰ˆæˆå“¡:', members.length);
                }

                // è‹¥ç•¶å‰è¡Œç¨‹æˆå“¡ç‚ºç©ºï¼Œå˜—è©¦å¾è©²è¡Œç¨‹çš„æ”¯å‡ºæ¨æ–·æˆå“¡ï¼ˆå³ä½¿æ”¯å‡ºå·²æœ‰ tripIdï¼‰
                if (currentTripId) {
                    const ct = trips.find(t => t.id === currentTripId);
                    if (ct && (!Array.isArray(ct.members) || ct.members.length === 0)) {
                        const inferredMembers2 = new Set();
                        (Array.isArray(expenses) ? expenses : []).filter(exp => exp.tripId === currentTripId).forEach(exp => {
                            if (exp && exp.payer) inferredMembers2.add(exp.payer);
                            if (exp && Array.isArray(exp.sharers)) exp.sharers.forEach(s => inferredMembers2.add(s));
                        });
                        if (inferredMembers2.size > 0) {
                            ct.members = Array.from(inferredMembers2);
                            members = [...ct.members];
                            if (!currentPayer || !members.includes(currentPayer)) currentPayer = members[0];
                            if (currentSharers.length === 0) currentSharers = [...members];
                            saveAllData();
                        }
                    }
                }

                // è‹¥æ²’æœ‰ä»»ä½•è¡Œç¨‹ï¼Œå»ºç«‹é è¨­è¡Œç¨‹ï¼Œä¸¦å¸¶å…¥èˆŠç‰ˆæˆå“¡ï¼ˆè‹¥æœ‰ï¼‰
                if (trips.length === 0) {
                    console.log('æ²’æœ‰è¡Œç¨‹ï¼Œå‰µå»ºé è¨­è¡Œç¨‹');
                    const defaultTrip = {
                        id: 'trip_' + Date.now(),
                        name: 'é è¨­è¡Œç¨‹',
                        createdAt: new Date().toISOString(),
                        members: Array.isArray(legacyMembers) ? [...legacyMembers] : []
                    };
                    trips.push(defaultTrip);
                    currentTripId = defaultTrip.id;
                    members = [...defaultTrip.members];
                    // è¨­å®šä»˜æ¬¾äººèˆ‡åˆ†æ”¤äºº
                    if (members.length > 0) {
                        currentPayer = members[0];
                        currentSharers = [...members];
                    } else {
                        currentPayer = null;
                        currentSharers = [];
                    }
                    console.log('å‰µå»ºé è¨­è¡Œç¨‹å®Œæˆ:', defaultTrip);
                    // ç«‹å³æŒä¹…åŒ–ï¼Œç¢ºä¿é¦–æ¬¡æ¸²æŸ“å¯ç”¨
                    saveAllData();
                }

                // å°‡æ²’æœ‰ tripId çš„èˆŠç‰ˆæ”¯å‡ºé·ç§»åˆ°ç•¶å‰è¡Œç¨‹ï¼Œä¸¦ä»¥å…¶æˆå“¡è£œé½Šç•¶å‰è¡Œç¨‹æˆå“¡ï¼ˆè‹¥ç‚ºç©ºï¼‰
                if (currentTripId && Array.isArray(expenses) && expenses.some(exp => !exp.tripId)) {
                    expenses = expenses.map(exp => ({ ...exp, tripId: exp.tripId || currentTripId }));
                    const ct = trips.find(t => t.id === currentTripId);
                    if (ct && (ct.members == null || ct.members.length === 0)) {
                        const inferredMembers = new Set();
                        expenses.filter(exp => exp.tripId === currentTripId).forEach(exp => {
                            if (exp.payer) inferredMembers.add(exp.payer);
                            if (Array.isArray(exp.sharers)) exp.sharers.forEach(s => inferredMembers.add(s));
                        });
                        ct.members = Array.from(inferredMembers);
                        members = [...ct.members];
                        if (members.length > 0) {
                            currentPayer = members.includes(currentPayer) ? currentPayer : members[0];
                            currentSharers = members.length > 0 ? [...members] : [];
                        }
                    }
                    saveAllData();
                }

                // ä¿®æ­£ currentPayer å’Œ currentSharers
                if (members.length > 0) {
                    // å¦‚æœæ²’æœ‰å„²å­˜çš„ payerï¼Œé è¨­ç‚ºç¬¬ä¸€å€‹æˆå“¡
                    if (!currentPayer || !members.includes(currentPayer)) {
                         currentPayer = members[0];
                    }
                    // å¦‚æœæ²’æœ‰å„²å­˜çš„ sharersï¼Œé è¨­ç‚ºå…¨é¸
                    if (currentSharers.length === 0) {
                        currentSharers = [...members];
                    }
                } else {
                    currentPayer = null;
                    currentSharers = [];
                }
                
            } catch (e) {
                console.error("è¼‰å…¥ Local Storage è³‡æ–™å¤±æ•—:", e);
                // å¤±æ•—æ™‚ä½¿ç”¨é è¨­å€¼
                exchangeRates = { ...defaultExchangeRates };
                trips = [];
                currentTripId = null;
                showMessage("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå·²ä½¿ç”¨é è¨­å€¼ã€‚", 'error');
            }
        }
        
        // --- Cloud Sync Helpers (Firebase Firestore) ---
        function genTripId(len = 24) {
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
          let out = '';
          for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
          return out;
        }
        function tripDocRef(tripId) { return db.collection('trips').doc(tripId); }
        function membersColRef(tripId) { return tripDocRef(tripId).collection('members'); }
        function expensesColRef(tripId) { return tripDocRef(tripId).collection('expenses'); }

        function serializeLocalTrip() {
          return {
            name: (trips.find(t => t.id === currentTripId) || {}).name || 'æœªå‘½åè¡Œç¨‹',
            baseCurrency: 'TWD',
            exchangeRates: exchangeRates || { TWD: 1 },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            updatedBy: 'web',
            members: members.map(m => ({ id: m, name: m })),
            expenses: expenses.filter(e => e.tripId === currentTripId)
          };
        }

        async function hydrateLocalFromCloud(tripId) {
          if (!db) db = await ensureDbReady();
          try {
            if (!db) { showMessage('Cloud not initialized', 'error'); return; }
            const doc = await tripDocRef(tripId).get();
            if (!doc.exists) throw new Error('Trip not found');
            const data = doc.data() || {};
            const memSnap = await membersColRef(tripId).get();
            const expSnap = await expensesColRef(tripId).get();
            const cloudMembers = memSnap.docs.map(d => (d.data() || {}).name).filter(Boolean);
            const cloudExpenses = expSnap.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));

            // Write back to local storage format
            exchangeRates = data.exchangeRates || { TWD: 1 };
            localStorage.setItem('travel_rates', JSON.stringify(exchangeRates));
            trips = [{
              id: tripId,
              name: data.name || 'æœªå‘½åè¡Œç¨‹',
              members: cloudMembers
            }];
            currentTripId = tripId;
            localStorage.setItem('travel_trips', JSON.stringify(trips));
            localStorage.setItem('travel_current_trip_id', currentTripId);
            members = cloudMembers;
            localStorage.setItem('travel_members', JSON.stringify(members));

            const localExps = cloudExpenses.map(x => ({
              id: x.id,
              tripId: tripId,
              description: x.description || '',
              category: x.category || '',
              amount: x.amount || 0,
              currency: x.currency || 'TWD',
              rateAtCreation: (x.rateAtCreation != null) ? x.rateAtCreation : 1,
              payer: x.payer || '',
              sharers: Array.isArray(x.sharers) ? x.sharers : [],
              customSplit: x.customSplit || null,
              createdAt: x.createdAt || new Date().toISOString(),
              createdByDeviceId: x.createdByDeviceId || '',
              createdByDeviceName: x.createdByDeviceName || ''
            }));
            expenses = localExps;
            localStorage.setItem('travel_expenses', JSON.stringify(expenses));

            // Re-render
            renderTrips();
            switchToTrip(currentTripId);
            justHydratedFromCloud = true;
          } catch (e) {
            console.error(e);
            showMessage('Link å¤±æ•—ï¼š' + (e.message || 'unknown'), 'error');
            throw e;
          }
        }

        async function pushTripToCloud(tripId) {
          try {
            if (!db) { showMessage('Cloud not initialized', 'error'); return; }
            const snap = serializeLocalTrip();
            await tripDocRef(tripId).set({
              name: snap.name,
              baseCurrency: snap.baseCurrency,
              exchangeRates: snap.exchangeRates,
              updatedAt: new Date().toISOString(),
              updatedBy: 'web'
            }, { merge: true });

            const memRef = membersColRef(tripId);
            const memDocs = await memRef.get();
            const batch = db.batch();
            memDocs.forEach(d => batch.delete(d.ref));
            snap.members.forEach(m => {
              const ref = memRef.doc(m.id);
              batch.set(ref, { name: m.name, updatedAt: new Date().toISOString(), updatedBy: 'web' });
            });
            await batch.commit();

            const expRef = expensesColRef(tripId);
            const expDocs = await expRef.get();
            const batch2 = db.batch();
            expDocs.forEach(d => batch2.delete(d.ref));
            snap.expenses.forEach(e => {
              const id = e.id || db.collection('_').doc().id;
              const ref = expRef.doc(id);
              const payload = {
                id,
                tripId,
                description: e.description || '',
                category: e.category || '',
                amount: e.amount || 0,
                currency: e.currency || 'TWD',
                rateAtCreation: e.rateAtCreation != null ? e.rateAtCreation : 1,
                payer: e.payer || '',
                sharers: Array.isArray(e.sharers) ? e.sharers : [],
                customSplit: e.customSplit || null,
                createdAt: e.createdAt || new Date().toISOString(),
                createdByDeviceId: e.createdByDeviceId || '',
                createdByDeviceName: e.createdByDeviceName || '',
                updatedAt: new Date().toISOString(),
                updatedBy: (DEVICE && DEVICE.name) ? DEVICE.name : 'web'
              };
              batch2.set(ref, payload, { merge: true });
            });
            await batch2.commit();
          } catch (e) {
            console.error(e);
            showMessage('Push å¤±æ•—ï¼š' + (e.message || 'unknown'), 'error');
            throw e;
          }
        }

        let unsubscribeCloud = null;
        async function subscribeTrip(tripId) {
          if (!db) db = await ensureDbReady();
          if (!db) { showMessage('Cloud not initialized', 'error'); return; }
          // Detach previous listeners if any
          if (unsubscribeCloud) { try { unsubscribeCloud(); } catch(_) {} unsubscribeCloud = null; }

          const tripRef = db.collection('trips').doc(tripId);
          const memRef  = tripRef.collection('members');
          const expRef  = tripRef.collection('expenses').orderBy('createdAt');

          const unsubs = [];

          // Trip doc updates: name and exchangeRates
          unsubs.push(
            tripRef.onSnapshot(doc => {
              if (!doc.exists) return;
              // Ignore only local pending writes; accept remote updates
              if (doc.metadata && doc.metadata.hasPendingWrites) return;
              isUpdatingFromCloud = true;
              const data = doc.data() || {};
              const idx = trips.findIndex(t => t.id === currentTripId);
              if (idx >= 0 && data.name) {
                trips[idx].name = data.name;
                localStorage.setItem('travel_trips', JSON.stringify(trips));
                updateHeaderTripName();
                renderTrips();
              }
              if (data.exchangeRates) {
                exchangeRates = data.exchangeRates;
                localStorage.setItem('travel_rates', JSON.stringify(exchangeRates));
                if (typeof renderExchangeRateInputs === 'function') renderExchangeRateInputs();
              }
              isUpdatingFromCloud = false;
            })
          );

          // Members subcollection
          unsubs.push(
            memRef.onSnapshot(snap => {
              if (snap.metadata && snap.metadata.hasPendingWrites) return;
              isUpdatingFromCloud = true;
              members = snap.docs.map(d => {
                const v = d.data();
                return (v && v.name) ? v.name : d.id;
              });
              localStorage.setItem('travel_members', JSON.stringify(members));
              renderMembers();
              if (typeof renderPayerChips === 'function') renderPayerChips();
              if (typeof renderShareChips === 'function') renderShareChips();
              isUpdatingFromCloud = false;
            })
          );

          // Expenses subcollection
          unsubs.push(
            expRef.onSnapshot(snap => {
              // DO NOT skip pendingWrites here â€” we want the writer device to see its own write instantly
              console.log('[Cloud] expenses snapshot size:', snap.size, 'trip:', tripId);
              console.log('[Cloud] first doc ids sample:', snap.docs.slice(0,3).map(d => d.id));
              isUpdatingFromCloud = true;
              const list = snap.docs.map(d => ({ id: d.id, ...(d.data() || {}), tripId }));
              expenses = list;
              localStorage.setItem('travel_expenses', JSON.stringify(expenses));
              renderExpenses();
              calculateAndRenderSettlement();
              isUpdatingFromCloud = false;
            })
          );

          // Group unsubscribe
          unsubscribeCloud = () => { unsubs.forEach(u => { try { u(); } catch(_) {} }); };
          // ç¢ºä¿ç•«é¢çœ‹çš„æ˜¯å·²åŒæ­¥çš„é›²ç«¯è¡Œç¨‹
          ensureViewingSyncedTrip();
        }

        // mirror local -> cloud (safe upsert, protect against empty local wiping cloud)
        async function mirrorLocalToCloud(tripId) {
          if (isSyncingToCloud || isUpdatingFromCloud) return;
          isSyncingToCloud = true;
          try {
            if (!db) db = await ensureDbReady();
            if (!tripId) return;

            const tripDoc = db.collection('trips').doc(tripId);
            const memRef = tripDoc.collection('members');
            const expRef = tripDoc.collection('expenses');

            // Count local data for current trip
            const localMem = members.slice();
            const localExp = expenses.filter(e => e.tripId === currentTripId);

            // Read remote counts
            const [remoteMemSnap, remoteExpSnap] = await Promise.all([memRef.get(), expRef.get()]);
            const remoteMemCount = remoteMemSnap.size;
            const remoteExpCount = remoteExpSnap.size;

            // Guard: do not wipe cloud if local is empty while remote has data
            if (localMem.length === 0 && localExp.length === 0 && (remoteMemCount > 0 || remoteExpCount > 0)) {
              console.warn('Mirror aborted: local empty but remote has data.');
              return;
            }

            // Upsert trip doc
            await tripDoc.set({
              name: getCurrentTripName(),
              baseCurrency: 'TWD',
              exchangeRates,
              updatedAt: new Date().toISOString()
            }, { merge: true });

            const batch = db.batch();

            // Members: upsert locals; delete extraneous only if we have locals
            const localMemIds = new Set(localMem.map(n => n));
            localMem.forEach(n => {
              batch.set(memRef.doc(n), { name: n, updatedAt: new Date().toISOString() }, { merge: true });
            });
            if (localMem.length > 0) {
              remoteMemSnap.forEach(d => { if (!localMemIds.has(d.id)) batch.delete(d.ref); });
            }

            // Expenses: upsert by id (create if missing); delete extras only if we have locals
            const remoteIds = new Set(remoteExpSnap.docs.map(d => d.id));
            localExp.forEach(e => {
              const chosenId = (e.id && typeof e.id === 'string') ? e.id : db.collection('_').doc().id;
              const ref = expRef.doc(chosenId);
              const payload = {
                id: chosenId,
                tripId: tripId,
                description: e.description || '',
                category: e.category || '',
                amount: e.amount || 0,
                currency: e.currency || 'TWD',
                rateAtCreation: (e.rateAtCreation != null) ? e.rateAtCreation : 1,
                payer: e.payer || '',
                sharers: Array.isArray(e.sharers) ? e.sharers : [],
                customSplit: e.customSplit || null,
                createdAt: e.createdAt || new Date().toISOString(),
                createdByDeviceId: e.createdByDeviceId || '',
                createdByDeviceName: e.createdByDeviceName || '',
                updatedAt: new Date().toISOString(),
                updatedBy: (DEVICE && DEVICE.name) ? DEVICE.name : 'web'
              };
              // Upsert (merge) to avoid wiping unknown fields from other writers
              batch.set(ref, payload, { merge: true });
            });
            if (localExp.length > 0) {
              remoteExpSnap.forEach(d => {
                const id = d.id;
                const existsLocally = localExp.some(le => (le.id || '') === id);
                if (!existsLocally) batch.delete(d.ref);
              });
            }

            await batch.commit();
            console.log('âœ… Safe mirror complete');
          } catch (e) {
            console.error('âŒ mirrorLocalToCloud failed:', e);
          } finally {
            isSyncingToCloud = false;
          }
        }

        // Link to a remote trip code: hydrate, set state, subscribe, then mirror once
        async function linkToTripCode(code) {
          try { db = await ensureDbReady(); } catch(e) { console.error(e); showMessage('Cloud not initialized (SDK load failed).', 'error'); return; }
          if (!code) { showMessage('è«‹è¼¸å…¥ä»£ç¢¼', 'warning'); return; }

          try {
            await hydrateLocalFromCloud(code);
            syncedTripId = code;
            setSyncedId(code);
            setCloudStatus('å·²åŒæ­¥ï¼š' + code);
            await subscribeTrip(code);
            ensureViewingSyncedTrip();
            // Do NOT mirror immediately after a cloud hydrate to avoid overwriting cloud with local empty.
            showMessage('Linked to cloud trip: ' + code, 'success');
          } catch (e) {
            const msg = 'æ‰¾ä¸åˆ°ä»£ç¢¼ ' + code + ' çš„é›²ç«¯è¡Œç¨‹ã€‚è¦ç”¨ä½ ç›®å‰çš„æœ¬æ©Ÿè³‡æ–™ä¾†å»ºç«‹å—ï¼Ÿ';
            showConfirmDialogGeneric(
              'å»ºç«‹é›²ç«¯è¡Œç¨‹',
              msg,
              () => { hideConfirmDialog(); },
              async () => {
                try {
                  await mirrorLocalToCloud(code);
                  syncedTripId = code;
                  setSyncedId(code);
                  setCloudStatus('å·²åŒæ­¥ï¼š' + code);
                  await subscribeTrip(code);
                  ensureViewingSyncedTrip();
                  showMessage('Created and linked: ' + code, 'success');
                } catch (err) {
                  console.error('pushTripToCloud failed:', err);
                  showMessage('å»ºç«‹é›²ç«¯è¡Œç¨‹å¤±æ•—ï¼š' + (err.message || ''), 'error');
                } finally { hideConfirmDialog(); }
              }
            );
            const keepBtn = document.getElementById('confirm-keep-expenses');
            const delBtn = document.getElementById('confirm-delete-expenses');
            if (keepBtn) keepBtn.textContent = 'å–æ¶ˆ';
            if (delBtn) delBtn.textContent = 'å»ºç«‹';
          }
        }

        // Cancel sync: unsubscribe and fork to a new local trip id
        function cancelSync() {
          if (typeof unsubscribeCloud === 'function') { unsubscribeCloud(); unsubscribeCloud = null; }
          if (unsubscribeTrip) { unsubscribeTrip(); unsubscribeTrip = null; }
          const newId = genTripId();
          const idx = trips.findIndex(t => t.id === currentTripId);
          if (idx >= 0) { trips[idx].id = newId; }
          expenses = expenses.map(e => (e.tripId === currentTripId ? { ...e, tripId: newId } : e));
          currentTripId = newId;
          syncedTripId = null;
          setSyncedId('');
          saveAllData();
          renderTrips();
          switchToTrip(currentTripId);
          setCloudStatus('æœªåŒæ­¥');
          showMessage('å·²å–æ¶ˆåŒæ­¥ï¼Œä¸¦è¤‡è£½ç‚ºä½ çš„ç¨ç«‹è¡Œç¨‹ã€‚', 'success');
        }

        /**
         * å„²å­˜æ‰€æœ‰æ ¸å¿ƒè³‡æ–™åˆ° Local Storage
         */
        function saveAllData() {
            if (isUpdatingFromCloud) return; // skip saves triggered by remote updates
            try {
                console.log('é–‹å§‹å„²å­˜è³‡æ–™...', {
                    trips: trips,
                    currentTripId: currentTripId,
                    members: members,
                    expenses: expenses
                });
                
                // å°‡ç•¶å‰è¡Œç¨‹çš„ members å¯«å› trips
                if (currentTripId) {
                    const ct = trips.find(t => t.id === currentTripId);
                    if (ct) {
                        ct.members = [...members];
                        console.log('æ›´æ–°è¡Œç¨‹æˆå“¡:', ct.name, 'æˆå“¡:', ct.members);
                    }
                }
                
                localStorage.setItem('travel_trips', JSON.stringify(trips));
                localStorage.setItem('travel_current_trip_id', currentTripId);
                // ä¿ç•™èˆŠéµä»¥ç›¸å®¹ï¼Œä½†å…§å®¹ç­‰åŒç›®å‰è¡Œç¨‹æˆå“¡
                localStorage.setItem('travel_members', JSON.stringify(members));
                localStorage.setItem('travel_expenses', JSON.stringify(expenses));
                // å„²å­˜æ™‚ï¼Œå¯ä»¥æ’é™¤ TWD (å› ç‚º TWD æ°¸é æ˜¯ 1)
                const ratesToSave = { ...exchangeRates };
                delete ratesToSave.TWD; 
                localStorage.setItem('travel_rates', JSON.stringify(ratesToSave));
                localStorage.setItem('travel_rate_update', rateLastUpdated);
                // ç´€éŒ„æœ€å¾Œç·¨è¼¯çš„è¡Œç¨‹ IDï¼ˆè‹¥ç„¡å‰‡å­˜ç©ºå­—ä¸²ï¼‰
                localStorage.setItem('travel_last_edited_trip_id', currentTripId || '');
                
                console.log('è³‡æ–™å„²å­˜å®Œæˆ');
            } catch (e) {
                console.error("å„²å­˜è³‡æ–™åˆ° Local Storage å¤±æ•—:", e);
                showMessage("è³‡æ–™å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚", 'error');
            }
            // auto-mirror to cloud when linked
            if (syncedTripId && db && !isUpdatingFromCloud) {
              if (justHydratedFromCloud) {
                console.log('skip one mirror after hydrate to protect cloud data');
                justHydratedFromCloud = false;
              } else {
                // fire-and-forget; do not block UI
                mirrorLocalToCloud(syncedTripId).catch((e) => console.warn('mirror failed:', e));
              }
            }
        }

        // å°‡ç›®å‰è³‡æ–™æ‰“åŒ…æˆ JSON å­—ä¸²
        function snapshotAllData() {
            return {
                travel_trips: JSON.parse(localStorage.getItem('travel_trips') || '[]'),
                travel_current_trip_id: localStorage.getItem('travel_current_trip_id') || null,
                travel_members: JSON.parse(localStorage.getItem('travel_members') || '[]'),
                travel_expenses: JSON.parse(localStorage.getItem('travel_expenses') || '[]'),
                travel_rates: JSON.parse(localStorage.getItem('travel_rates') || '{}'),
                travel_rate_update: localStorage.getItem('travel_rate_update') || '',
                travel_last_edited_trip_id: localStorage.getItem('travel_last_edited_trip_id') || ''
            };
        }

        

        function exportTripToExcel() {
          if (!currentTripId) { showMessage('Please select a trip first.', 'warning'); return; }
          const trip = trips.find(t => t.id === currentTripId);
          if (!trip) { showMessage('Current trip not found.', 'error'); return; }

          const tripExpenses = expenses.filter(exp => exp.tripId === currentTripId);
          if (tripExpenses.length === 0) { showMessage('No expenses in this trip.', 'warning'); return; }

          const wb = new ExcelJS.Workbook();

          // ===== Sheet 1: Expenses =====
          const s1 = wb.addWorksheet('Expenses');
          const head1 = ['Description','Category','Amount','Currency','Payer','Sharers','CustomSplit','CreatedAt','RateUsed','TWD (approx)'];
          s1.addRow(head1);
          console.log('[Excel Export] header:', head1);
          head1.forEach((_, i)=>{ const c = s1.getRow(1).getCell(i+1); c.font={bold:true,color:{argb:'FFFFFFFF'}}; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF4F46E5'}}; });

          tripExpenses.forEach(exp => {
            const sharersText = Array.isArray(exp.sharers) ? exp.sharers.join(', ') : '';
            const customSplitText = exp.customSplit
              ? Object.entries(exp.customSplit).map(([n,v]) => `${n}: ${(exp.currency||'')} ${v}`).join('; ')
              : '';
            const twd = convertExpenseToTWD(exp);
            // Rate used at creation (fallback to current exchange rate or 1)
            const rateUsed = (exp.rateAtCreation != null)
              ? exp.rateAtCreation
              : ((exp.currency && exchangeRates && exchangeRates[exp.currency] != null) ? exchangeRates[exp.currency] : 1);

            console.log('[Excel Export] rateUsed for row:', rateUsed);
            s1.addRow([
              exp.description || '',
              exp.category || '',
              exp.amount ?? '',
              exp.currency || '',
              exp.payer || '',
              sharersText,
              customSplitText,
              exp.createdAt ? new Date(exp.createdAt).toISOString() : '',
              `${exp.currency || 'TWD'}â†’TWD: ${rateUsed}`,
              Math.round(twd)
            ]);
          });
          s1.columns = head1.map((_, i) => ({ width: (i >= 8 ? 22 : 20) }));

          // ===== Sheet 2: Summary =====
          const s2 = wb.addWorksheet('Summary');

          // Title
          s2.mergeCells(1,1,1,4);
          const titleCell = s2.getCell(1,1);
          titleCell.value = `${trip.name || 'Trip'} - Summary`;
          titleCell.font = { bold:true, size:14 };

          // Trip total (TWD)
          let tripTotalTWD = 0;
          tripExpenses.forEach(e => { tripTotalTWD += convertExpenseToTWD(e); });
          s2.addRow([]);
          s2.addRow(['Trip Total (TWD)', Math.round(tripTotalTWD)]);
          s2.getRow(s2.lastRow.number).getCell(1).font = { bold:true };
          s2.getRow(s2.lastRow.number).getCell(2).font = { bold:true };

          // Per-member table
          const balances = calculateBalances();
          s2.addRow([]);
          const head2 = ['Member','Actual Paid (TWD)','Theoretical Spend (TWD)','Net (TWD)','Status'];
          s2.addRow(head2);
          head2.forEach((_, i)=> s2.getRow(s2.lastRow.number).getCell(i+1).font={bold:true});

          Array.from(balances.entries()).forEach(([member, data]) => {
            const paid = Math.round(data.paid||0);
            const spent = Math.round(data.spent||0);
            const net = Math.round((data.net||0));
            let status = 'Balanced';
            if (net > 0) status = 'Receivable ' + net;
            if (net < 0) status = 'Payable ' + Math.abs(net);
            s2.addRow([member, paid, spent, net, status]);
          });

          // Settlement path
          const settlements = simplifyDebts(balances);
          s2.addRow([]);
          s2.addRow(['Settlement Path']);
          s2.getRow(s2.lastRow.number).getCell(1).font = { bold:true };
          if (settlements.length === 0) {
            s2.addRow(['No settlement needed (within tolerance).']);
          } else {
            s2.addRow(['From','To','Amount (TWD)']);
            s2.getRow(s2.lastRow.number).eachCell(c => c.font = { bold:true });
            settlements.forEach(s => s2.addRow([s.from, s.to, Math.round(s.amount)]));
          }

          // Exchange rate snapshot
          s2.addRow([]);
          s2.addRow(['Exchange Rates (Base TWD)']);
          s2.getRow(s2.lastRow.number).getCell(1).font = { bold:true };
          s2.addRow(['Currency','Rate']);
          s2.getRow(s2.lastRow.number).eachCell(c => c.font = { bold:true });
          Object.entries(exchangeRates || {TWD:1}).forEach(([code, rate]) => s2.addRow([code, rate]));

          s2.columns = [{width:24},{width:18},{width:18},{width:14},{width:18}];

          // Download
          wb.xlsx.writeBuffer().then(buf=>{
            const blob = new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const stamp = new Date().toISOString().replace(/[:.]/g,'-');
            const EXPORT_SCHEMA_VERSION = 'v-rateUsed';
            a.href = url;
            a.download = `${trip.name || 'trip'}-${EXPORT_SCHEMA_VERSION}-${stamp}.xlsx`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('Excel exported with summary.', 'success');
          }).catch(e=>{
            console.error(e);
            showMessage('Excel export failed: ' + (e.message||''), 'error');
          });
        }

        function markTripEdited(tripId) {
            lastEditedTripId = tripId;
            const t = trips.find(x => x.id === tripId);
            if (t) t.updatedAt = new Date().toISOString();
            localStorage.setItem('travel_last_edited_trip_id', tripId || '');
        }

        // --- å·¥å…·å‡½æ•¸ ---

        /**
         * é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯æ–¹å¡Š
         * @param {string} message 
         * @param {string} type 
         */
        function showMessage(message, type = 'warning') {
            messageContentEl.textContent = message;
            // é¡¯ç¤ºå‰å…ˆæ¸…ç†æ¨£å¼
            messageContentEl.className = 'max-w-sm mx-auto p-3 rounded-lg shadow-xl text-center font-medium';
            // é¡å‹æ¨£å¼
            if (type === 'warning') {
                messageContentEl.classList.add('bg-yellow-500', 'text-white');
            } else if (type === 'success') {
                messageContentEl.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                messageContentEl.classList.add('bg-red-500', 'text-white');
            }
            // æ­£ç¢ºé¡¯ç¤º
            messageBoxEl.classList.remove('hidden');
            messageBoxEl.style.display = 'block';

            // 3 ç§’å¾Œç¢ºå¯¦é—œé–‰ï¼ˆåŒæ™‚ç§»é™¤ inline styleï¼‰
            setTimeout(() => {
                messageBoxEl.classList.add('hidden');
                messageBoxEl.style.display = 'none';
            }, 3000);
        }

        /**
         * é¡¯ç¤ºç¢ºèªå°è©±æ¡†
         * @param {string} memberName è¦åˆªé™¤çš„æˆå“¡åç¨±
         * @param {number} expenseCount ç›¸é—œæ”¯å‡ºè¨˜éŒ„æ•¸é‡
         */
        function showConfirmDialog(memberName, expenseCount) {
            confirmTitleEl.textContent = 'åˆªé™¤æˆå“¡ç¢ºèª';
            confirmMessageEl.innerHTML = `
                æˆå“¡ "<strong>${memberName}</strong>" æœ‰ <strong>${expenseCount}</strong> ç­†ç›¸é—œæ”¯å‡ºè¨˜éŒ„ã€‚<br><br>
                è«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š
            `;
            pendingMemberName = memberName;
            // æ¸…ç©ºä»»ä½•é€šç”¨è™•ç†å™¨ï¼Œæ”¹ç”¨æˆå“¡åˆªé™¤é è¨­æµç¨‹
            confirmKeepHandler = null;
            confirmDeleteHandler = null;
            // é¡¯ç¤ºä¸¦é–å®šèƒŒæ™¯æ»¾å‹•
            confirmDialogEl.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        /**
         * é€šç”¨ç¢ºèªå°è©±æ¡† (è‡ªå®šç¾©æ¨™é¡Œ/è¨Šæ¯èˆ‡è¡Œç‚º)
         * @param {string} title
         * @param {string} htmlMessage
         * @param {Function|null} onKeep
         * @param {Function|null} onDelete
         */
        function showConfirmDialogGeneric(title, htmlMessage, onKeep, onDelete) {
            confirmTitleEl.textContent = title;
            confirmMessageEl.innerHTML = htmlMessage;
            pendingMemberName = null; // é¿å…èª¤è§¸ç”¨æˆå“¡åˆªé™¤é‚è¼¯
            confirmKeepHandler = typeof onKeep === 'function' ? onKeep : null;
            confirmDeleteHandler = typeof onDelete === 'function' ? onDelete : null;
            // é¡¯ç¤ºä¸¦é–å®šèƒŒæ™¯æ»¾å‹•
            confirmDialogEl.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        /**
         * éš±è—ç¢ºèªå°è©±æ¡†
         */
        function hideConfirmDialog() {
            confirmDialogEl.classList.add('hidden');
            pendingMemberName = null;
            // è§£é™¤èƒŒæ™¯é–å®š
            document.body.classList.remove('overflow-hidden');
        }

        /**
         * å°‡ä»»æ„å¹£åˆ¥é‡‘é¡è½‰æ›ç‚º TWD
         * @param {number} amount 
         * @param {string} currency 
         * @returns {number} TWD equivalent
         */
        function convertToTWD(amount, currency) {
            // ç¢ºä¿åŒ¯ç‡å­˜åœ¨ï¼Œå¦å‰‡ä½¿ç”¨ 1 (TWD)
            const rate = exchangeRates[currency] || 1; 
            return amount * rate;
        }

        // ä»¥å–®ç­†æ”¯å‡ºæ‰€å»ºç«‹æ™‚çš„åŒ¯ç‡æ›ç®—ç‚º TWDï¼ˆè‹¥æœ‰ä¿å­˜ rateAtCreation å‰‡å„ªå…ˆä½¿ç”¨ï¼‰
        function convertExpenseToTWD(exp) {
            const amt = Number(exp && exp.amount != null ? exp.amount : 0);
            const cur = exp && exp.currency ? exp.currency : 'TWD';
            let rate = 1;
            if (exp && exp.rateAtCreation != null) {
                rate = Number(exp.rateAtCreation) || 0;
            } else if (cur === 'TWD') {
                rate = 1;
            } else if (exchangeRates && exchangeRates[cur] != null) {
                rate = Number(exchangeRates[cur]) || 0;
            } else {
                rate = 0;
            }
            return Math.round(amt * rate);
        }

        // ä¸€æ¬¡æ€§è£œé½ŠèˆŠæ”¯å‡ºç¼ºå°‘çš„å»ºç«‹æ™‚åŒ¯ç‡ï¼ˆå¯é¸ï¼‰
        function backfillRateAtCreationIfMissing() {
            let changed = false;
            expenses.forEach(exp => {
                if (exp && exp.rateAtCreation == null) {
                    exp.rateAtCreation = (exp.currency === 'TWD') ? 1 : (exchangeRates[exp.currency] || 0);
                    changed = true;
                }
            });
            if (changed) { saveAllData(); showMessage('Stamped rates for existing expenses.', 'success'); }
        }

        /**
         * æ ¼å¼åŒ–é‡‘é¡ï¼Œä¿ç•™å…©ä½å°æ•¸ï¼ŒåŠ å…¥åƒä½åˆ†éš”ç¬¦
         * @param {number} amount 
         * @param {number} decimals 
         * @returns {string}
         */
        function formatAmount(amount, decimals = 2) {
            if (typeof amount !== 'number' || isNaN(amount)) return '0.00';
            // å››æ¨äº”å…¥åˆ°æŒ‡å®šä½æ•¸
            const roundedAmount = Math.round(amount * Math.pow(10, decimals)) / Math.pow(10, decimals);
            return roundedAmount.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        // --- FX helpers ---
        function getStoredRates() {
          try { return JSON.parse(localStorage.getItem('travel_rates') || '{}'); } catch(e) { return {}; }
        }
        function setStoredRates(obj) {
          localStorage.setItem('travel_rates', JSON.stringify(obj || {}));
        }
        function getStoredRateUpdatedAt() {
          return localStorage.getItem('travel_rate_update') || '';
        }
        function setStoredRateUpdatedAt(val) {
          localStorage.setItem('travel_rate_update', val || '');
        }
        async function fetchLiveRates(baseCurrency) {
          // We will fetch with USD base (more widely supported), then convert to TWD-base rates.
          // Fallback: open.er-api.com if exchangerate.host fails.
          const wanted = Object.keys(exchangeRates || { TWD:1, USD:1, JPY:1, KRW:1, EUR:1, CNY:1 });
          if (!wanted.includes('TWD')) wanted.push('TWD');
          if (!wanted.includes('USD')) wanted.push('USD');

          async function fetchFromHost() {
            // exchangerate.host with USD base
            const url = 'https://api.exchangerate.host/latest?base=USD&symbols=' + encodeURIComponent(wanted.join(','));
            const res = await fetch(url);
            if (!res.ok) throw new Error('exchangerate.host HTTP ' + res.status);
            const data = await res.json();
            if (!data || !data.rates || !data.rates.TWD) throw new Error('exchangerate.host returned no usable data');
            return data.rates; // USD->X
          }

          async function fetchFromErApi() {
            // open.er-api.com with USD base
            const url = 'https://open.er-api.com/v6/latest/USD';
            const res = await fetch(url);
            if (!res.ok) throw new Error('open.er-api.com HTTP ' + res.status);
            const data = await res.json();
            if (!data || !data.rates || !data.rates.TWD) throw new Error('open.er-api returned no usable data');
            // Keep only needed symbols
            const filtered = {};
            wanted.forEach(k => { if (data.rates[k] != null) filtered[k] = data.rates[k]; });
            return filtered; // USD->X
          }

          try {
            // 1) Try exchangerate.host first
            let usdToX = await fetchFromHost();
            // 2) Convert USD-base table to TWD-base table
            const twdPerUsd = usdToX.TWD; // TWD per 1 USD
            const twdBase = { TWD: 1 };
            wanted.forEach(code => {
              if (code === 'TWD') return;
              const usdToCode = usdToX[code];
              if (usdToCode && usdToCode > 0) {
                // 1 code = (TWD per USD) / (code per USD) TWD
                twdBase[code] = twdPerUsd / usdToCode;
              }
            });
            exchangeRates = twdBase;
            setStoredRates(Object.assign({}, twdBase, { TWD: undefined })); // store without forcing TWD
            setStoredRateUpdatedAt(new Date().toISOString());
            if (typeof renderExchangeRateInputs === 'function') renderExchangeRateInputs();
            const el = document.getElementById('rates-updated-at');
            if (el) el.textContent = 'Updated: ' + new Date().toLocaleString('zh-TW');
            showMessage('Rates updated', 'success');
            calculateAndRenderSettlement();
            saveAllData();
          } catch (e1) {
            console.warn('exchangerate.host failed, trying fallback...', e1);
            try {
              // Fallback: open.er-api.com
              let usdToX = await fetchFromErApi();
              const twdPerUsd = usdToX.TWD;
              if (!twdPerUsd) throw new Error('Fallback has no TWD');
              const twdBase = { TWD: 1 };
              wanted.forEach(code => {
                if (code === 'TWD') return;
                const usdToCode = usdToX[code];
                if (usdToCode && usdToCode > 0) {
                  twdBase[code] = twdPerUsd / usdToCode;
                }
              });
              exchangeRates = twdBase;
              setStoredRates(Object.assign({}, twdBase, { TWD: undefined }));
              setStoredRateUpdatedAt(new Date().toISOString());
              if (typeof renderExchangeRateInputs === 'function') renderExchangeRateInputs();
              const el = document.getElementById('rates-updated-at');
              if (el) el.textContent = 'Updated: ' + new Date().toLocaleString('zh-TW');
              showMessage('Rates updated (fallback)', 'success');
              calculateAndRenderSettlement();
              saveAllData();
            } catch (e2) {
              console.error('Both FX sources failed', e2);
              showMessage('Failed to fetch rates from both sources', 'error');
            }
          }
        }
        
        // --- åŒ¯ç‡ç®¡ç†é‚è¼¯ ---

        /**
         * æ¸²æŸ“åŒ¯ç‡è¼¸å…¥æ¬„ä½
         */
        function renderExchangeRateInputs() {
            // Pull latest from storage first
            const latest = getStoredRates();
            if (latest && Object.keys(latest).length > 0) {
                exchangeRates = { 'TWD': 1, ...latest };
            }
            const storedTs = getStoredRateUpdatedAt();
            if (storedTs) rateLastUpdated = storedTs;

            exchangeRateInputsEl.innerHTML = '';

            // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
            rateLastUpdatedEl.textContent = `ä¸Šæ¬¡åŒ¯ç‡æ›´æ–°æ™‚é–“: ${rateLastUpdated}`;

            // Build rows with per-currency delete button
            const container = document.getElementById('exchange-rate-inputs');
            if (!container) return;
            container.innerHTML = '';
            const entries = Object.entries(exchangeRates);
            entries.forEach(([code, rate]) => {
                const row = document.createElement('div');
                row.className = 'flex flex-col sm:flex-row items-start sm:items-center gap-2 mb-3 sm:mb-2 w-full';

                const label = document.createElement('label');
                label.textContent = code;
                label.className = 'sm:w-16 w-full font-medium text-gray-700 break-words';

                const input = document.createElement('input');
                input.type = 'number';
                input.value = rate || 0;
                input.min = '0';
                input.step = '0.0001';
                input.inputMode = 'decimal';
                input.className = 'w-full sm:flex-1 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm min-w-0';
                input.addEventListener('input', () => {
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) {
                        exchangeRates[code] = val;
                        saveAllData();
                        calculateAndRenderSettlement();
                    }
                });

                let delBtn = null;
                if (code !== 'TWD') {
                    delBtn = document.createElement('button');
                    delBtn.textContent = 'âœ•';
                    delBtn.title = 'Delete ' + code;
                    delBtn.className = 'px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs mt-1 sm:mt-0';
                    delBtn.addEventListener('click', () => {
                        if (confirm('Remove ' + code + ' from currency list?')) {
                            delete exchangeRates[code];
                            saveAllData();
                            renderExchangeRateInputs();
                            showMessage(code + ' removed.', 'success');
                        }
                    });
                }

                row.appendChild(label);
                row.appendChild(input);
                if (delBtn) row.appendChild(delBtn);
                container.appendChild(row);
            });
            // ç¢ºä¿è¨˜éŒ„æ”¯å‡ºçš„å¹£åˆ¥é¸å–®ä¹Ÿæ›´æ–° (å¦‚æœæœ‰æ–°å¢å¹£åˆ¥çš„è©±)
            updateCurrencySelectOptions();
        }

        // æ–°å¢/ç§»é™¤å¹£åˆ¥
        function addCurrency() {
            const input = document.getElementById('new-currency-input');
            const code = (input && input.value ? input.value : '').trim().toUpperCase();
            if (!code) { showMessage('Please enter a currency code', 'warning'); return; }
            if (exchangeRates[code] != null) { showMessage(code + ' already exists', 'warning'); return; }
            if (code === 'TWD') { showMessage('TWD already exists', 'warning'); return; }
            exchangeRates[code] = 0; // user should input a value or refresh via API
            saveAllData();
            renderExchangeRateInputs();
            showMessage(code + ' added. Please input its rate.', 'success');
            if (input) input.value = '';
        }
        // standalone removeCurrency removed; deletion is handled per-row

        /**
         * æ›´æ–°å–®ä¸€åŒ¯ç‡
         * @param {string} currency 
         * @param {string} value 
         */
        function updateRate(currency, value) {
            const newRate = parseFloat(value);
            if (newRate > 0) {
                exchangeRates[currency] = newRate;
                showMessage(`${currency} åŒ¯ç‡å·²æ›´æ–°ç‚º ${newRate}ã€‚`, 'success');
                // å„²å­˜è³‡æ–™
                saveAllData(); 
                // é‡æ–°è¨ˆç®—æ‰€æœ‰çµç®—æ•¸æ“š
                calculateAndRenderSettlement();
                // æ›´æ–°æ™‚é–“
                rateLastUpdated = new Date().toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                rateLastUpdatedEl.textContent = `ä¸Šæ¬¡åŒ¯ç‡æ›´æ–°æ™‚é–“: ${rateLastUpdated}`;

            } else {
                showMessage('åŒ¯ç‡å¿…é ˆæ˜¯æ­£æ•¸ã€‚', 'error');
                // æ¢å¾©èˆŠå€¼
                document.getElementById(`rate-${currency}`).value = exchangeRates[currency];
            }
        }
        
        /**
         * æ›´æ–°è¨˜éŒ„æ”¯å‡ºå¡ç‰‡ä¸­çš„å¹£åˆ¥é¸å–®
         */
        function updateCurrencySelectOptions() {
            if (!expenseCurrencySelect) return;

            const currentCurrencies = Array.from(expenseCurrencySelect.options).map(o => o.value);
            const availableCurrencies = Object.keys(exchangeRates);

            // ç§»é™¤å·²ä¸å­˜åœ¨çš„å¹£åˆ¥é¸é …
            for (let i = expenseCurrencySelect.options.length - 1; i >= 0; i--) {
                const option = expenseCurrencySelect.options[i];
                if (!availableCurrencies.includes(option.value)) {
                    expenseCurrencySelect.remove(i);
                }
            }

            // æ–°å¢å°šæœªåœ¨é¸å–®ä¸­çš„å¹£åˆ¥é¸é …
            availableCurrencies.forEach(currency => {
                if (!currentCurrencies.includes(currency)) {
                    const option = document.createElement('option');
                    option.value = currency;
                    option.textContent = currency;
                    expenseCurrencySelect.appendChild(option);
                }
            });
        }
        
        // --- é¡åˆ¥æ™¶ç‰‡æ¸²æŸ“èˆ‡é¸æ“‡ ---
        
        /**
         * æ¸²æŸ“é¡åˆ¥é¸æ“‡æ™¶ç‰‡
         */
        function renderCategoryChips() {
            categoryChipsEl.innerHTML = '';
            categories.forEach(category => {
                const isActive = category === currentCategory;
                const chip = document.createElement('div');
                chip.className = `chip-base ${isActive ? 'chip-category-active' : 'chip-category-inactive hover:bg-green-100'}`;
                chip.textContent = category;
                chip.onclick = () => selectCategory(category);
                categoryChipsEl.appendChild(chip);
            });
        }

        /**
         * é¸æ“‡é¡åˆ¥
         * @param {string} category 
         */
        function selectCategory(category) {
            currentCategory = category;
            renderCategoryChips();
        }


        // --- è¡Œç¨‹ç®¡ç†é‚è¼¯ ---

        /**
         * æ–°å¢è¡Œç¨‹
         */
        function addTrip() {
            const name = tripNameInput.value.trim();
            console.log('å˜—è©¦æ–°å¢è¡Œç¨‹:', name);
            if (name.length > 0 && !trips.some(trip => trip.name === name)) {
                const id = genTripId();
                const newTrip = {
                    id,
                    name: name,
                    createdAt: new Date().toISOString(),
                    members: []
                };
                trips.push(newTrip);
                console.log('æ–°å¢è¡Œç¨‹æˆåŠŸ:', newTrip);
                // æ–°è¡Œç¨‹è‡ªå‹•æˆç‚ºç•¶å‰è¡Œç¨‹
                currentTripId = id;
                markTripEdited(currentTripId);
                tripNameInput.value = '';
                // æ¸…ç©ºæˆå“¡åˆ—è¡¨ï¼Œå› ç‚ºæ–°è¡Œç¨‹æ²’æœ‰æˆå“¡
                members = [];
                currentPayer = null;
                currentSharers = [];
                renderTrips();
                renderMembers();
                renderPayerChips();
                renderShareChips();
                saveAllData();
                showMessage(`è¡Œç¨‹ "${name}" å·²æ–°å¢ä¸¦è¨­ç‚ºç•¶å‰è¡Œç¨‹ï¼`, 'success');
                updateHeaderTripName();

                // Pre-fill cloud code box with the new trip id
                const codeInput2 = document.getElementById('trip-code-input');
                if (codeInput2) codeInput2.value = id;

                // Automatically upload this trip to Firestore (if Firebase is configured)
                try {
                    if (window.firebase && (firebase.apps.length || firebaseConfig.apiKey)) {
                        console.log('ğŸš€ Auto-linking new trip to cloud: ' + id);
                        linkToTripCode(id)
                          .then(() => {
                            showMessage('å·²è‡ªå‹•å»ºç«‹é›²ç«¯è¡Œç¨‹ä¸¦åŒæ­¥ï¼š' + id, 'success');
                          })
                          .catch((e) => {
                            console.error('Auto-link failed:', e);
                            showMessage('è‡ªå‹•ä¸Šå‚³é›²ç«¯å¤±æ•—ï¼š' + (e.message || ''), 'error');
                          });
                    } else {
                        console.log('Firebase not ready, skipping auto-link.');
                    }
                } catch (e) {
                    console.error('Auto-link failed:', e);
                    showMessage('è‡ªå‹•ä¸Šå‚³é›²ç«¯å¤±æ•—ï¼š' + (e.message || ''), 'error');
                }
            } else if (name.length > 0) {
                showMessage(`è¡Œç¨‹ "${name}" å·²å­˜åœ¨ã€‚`, 'warning');
            } else {
                showMessage('è¡Œç¨‹åç¨±ä¸èƒ½ç‚ºç©ºã€‚', 'warning');
            }
        }

        /**
         * åˆ‡æ›åˆ°æŒ‡å®šè¡Œç¨‹
         * @param {string} tripId è¡Œç¨‹ ID
         */
        function switchToTrip(tripId) {
            currentTripId = tripId;
            // è¼‰å…¥è©²è¡Œç¨‹çš„æˆå“¡ï¼ˆæ¯å€‹è¡Œç¨‹å„è‡ªç¨ç«‹ï¼‰
            const t = trips.find(t => t.id === tripId);
            members = t && Array.isArray(t.members) ? [...t.members] : [];
            // èª¿æ•´ä»˜æ¬¾äººèˆ‡åˆ†æ”¤äººç‹€æ…‹
            if (members.length > 0) {
                if (!currentPayer || !members.includes(currentPayer)) currentPayer = members[0];
                if (currentSharers.length === 0) currentSharers = [...members];
                currentSharers = currentSharers.filter(s => members.includes(s));
            } else {
                currentPayer = null;
                currentSharers = [];
            }
            // è¼‰å…¥è©²è¡Œç¨‹çš„æ”¯å‡ºè¨˜éŒ„
            loadTripExpenses();
            renderTrips();
            // ä¹ŸåŒæ­¥æ›´æ–°æˆå“¡ç®¡ç†ï¼ˆäººæ•¸/æ™¶ç‰‡ï¼‰
            renderMembers();
            renderPayerChips();
            renderShareChips();
            renderExpenses();
            calculateAndRenderSettlement();
            markTripEdited(tripId);
            saveAllData();
            
            const trip = trips.find(t => t.id === tripId);
            showMessage(`å·²åˆ‡æ›åˆ°è¡Œç¨‹ "${trip.name}"`, 'success');
            // ç¢ºä¿ä¸‹æ‹‰åŒæ­¥ç•¶å‰é¸æ“‡
            if (tripSelectEl && tripSelectEl.value !== tripId) {
                tripSelectEl.value = tripId;
            }
            updateHeaderTripName();

            // Auto-fill cloud code input with current trip id
            const codeInput = document.getElementById('trip-code-input');
            if (codeInput) codeInput.value = tripId || '';

            // If this trip is the cloud-linked one, ensure we are subscribed
            (async () => {
              try {
                if (syncedTripId && tripId === syncedTripId) {
                  if (!db) db = await ensureDbReady();
                  await subscribeTrip(syncedTripId);
                }
              } catch (e) { console.warn('Auto-subscribe on switch failed:', e); }
            })();

            // Align view with synced trip if needed
            try { ensureViewingSyncedTrip(); } catch (_) {}
        }

        /**
         * åˆªé™¤è¡Œç¨‹
         * @param {string} tripId è¡Œç¨‹ ID
         */
        function deleteTrip(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;

            // æª¢æŸ¥æ˜¯å¦æœ‰æ”¯å‡ºè¨˜éŒ„
            const tripExpenses = expenses.filter(exp => exp.tripId === tripId);
            
            if (tripExpenses.length > 0) {
                const title = 'åˆªé™¤è¡Œç¨‹ç¢ºèª';
                const msg = `è¡Œç¨‹ "<strong>${trip.name}</strong>" æœ‰ <strong>${tripExpenses.length}</strong> ç­†ç›¸é—œæ”¯å‡ºè¨˜éŒ„ã€‚<br><br>è«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š`;
                // ä¿ç•™è¨˜éŒ„ï¼šåˆªé™¤è¡Œç¨‹ï¼Œä½†ä¿ç•™è©²è¡Œç¨‹çš„æ”¯å‡ºï¼ˆå°‡å…¶ tripId è¨­ç‚º nullï¼‰
                const onKeep = () => executeDeleteTrip(tripId, /*removeExpenses*/ false);
                // åˆªé™¤è¨˜éŒ„ï¼šåˆªé™¤è¡Œç¨‹ä¸¦åˆªé™¤æ‰€æœ‰ç›¸é—œæ”¯å‡º
                const onDelete = () => executeDeleteTrip(tripId, /*removeExpenses*/ true);
                showConfirmDialogGeneric(title, msg, onKeep, onDelete);
            } else {
                // æ²’æœ‰æ”¯å‡ºè¨˜éŒ„ï¼Œç›´æ¥åˆªé™¤
                executeDeleteTrip(tripId, /*removeExpenses*/ true);
            }
        }

        /**
         * åŸ·è¡Œåˆªé™¤è¡Œç¨‹
         * @param {string} tripId
         * @param {boolean} removeExpenses è‹¥ç‚º trueï¼Œåˆªé™¤è©²è¡Œç¨‹æ‰€æœ‰æ”¯å‡ºï¼›false å‰‡ä¿ç•™ï¼ˆtripId è¨­ç‚º nullï¼‰
         */
        function executeDeleteTrip(tripId, removeExpenses) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) { hideConfirmDialog(); return; }

            // åˆªé™¤è¡Œç¨‹
            trips = trips.filter(t => t.id !== tripId);

            if (removeExpenses) {
                expenses = expenses.filter(exp => exp.tripId !== tripId);
            } else {
                // ä¿ç•™è¨˜éŒ„ï¼šå°‡è©²è¡Œç¨‹çš„æ”¯å‡º tripId ç½®ç‚º null
                expenses = expenses.map(exp => exp.tripId === tripId ? { ...exp, tripId: null } : exp);
            }

            // è‹¥åˆªé™¤çš„æ˜¯ç•¶å‰è¡Œç¨‹ï¼Œåˆ‡æ›åˆ°æœ€å¾Œä¸€å€‹è¡Œç¨‹
            if (currentTripId === tripId) {
                currentTripId = trips.length > 0 ? trips[trips.length - 1].id : null;
                loadTripExpenses();
            }

            renderTrips();
            updateHeaderTripName();
            renderExpenses();
            calculateAndRenderSettlement();
            // æ›´æ–°æœ€å¾Œç·¨è¼¯è¡Œç¨‹æ¨™è¨˜
            if (currentTripId) {
                markTripEdited(currentTripId);
            } else {
                localStorage.removeItem('travel_last_edited_trip_id');
            }
            saveAllData();

            const actionMsg = removeExpenses ? 'ï¼ˆå·²åˆªé™¤ç›¸é—œæ”¯å‡ºï¼‰' : 'ï¼ˆä¿ç•™ç›¸é—œæ”¯å‡ºï¼‰';
            showMessage(`è¡Œç¨‹ "${trip.name}" å·²åˆªé™¤ ${actionMsg}`, 'success');
            hideConfirmDialog();
        }

        /**
         * è¼‰å…¥ç•¶å‰è¡Œç¨‹çš„æ”¯å‡ºè¨˜éŒ„
         */
        function loadTripExpenses() {
            // é€™è£¡å¯ä»¥æ ¹æ“šéœ€è¦è¼‰å…¥ç‰¹å®šè¡Œç¨‹çš„æ”¯å‡ºè¨˜éŒ„
            // ç›®å‰æ‰€æœ‰æ”¯å‡ºéƒ½å…±ç”¨ï¼Œæœªä¾†å¯ä»¥æŒ‰è¡Œç¨‹åˆ†é›¢
        }

        /**
         * æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨
         */
        function renderTrips() {
            console.log('renderTrips called, trips:', trips, 'currentTripId:', currentTripId);
            tripListEl.innerHTML = '';
            
            if (trips.length === 0) {
                tripListEl.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-4">å°šç„¡è¡Œç¨‹</p>';
                // æ¸…ç©ºä¸‹æ‹‰é¸å–®
                if (tripSelectEl) {
                    tripSelectEl.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'å°šç„¡è¡Œç¨‹';
                    tripSelectEl.appendChild(opt);
                    tripSelectEl.disabled = true;
                }
                // æ›´æ–°ç•¶å‰è¡Œç¨‹é¡¯ç¤º
                currentTripNameEl.textContent = 'ç„¡è¡Œç¨‹';
                currentTripStatsEl.textContent = '0 ç­†æ”¯å‡º';
                console.log('æ²’æœ‰è¡Œç¨‹ï¼Œé¡¯ç¤ºç„¡è¡Œç¨‹ç‹€æ…‹');
                return;
            }
            
            trips.forEach(trip => {
                const tripItem = document.createElement('div');
                const isActive = trip.id === currentTripId;
                const tripExpenses = expenses.filter(exp => exp.tripId === trip.id);
                
                tripItem.className = `p-3 rounded-lg border cursor-pointer transition-all ${
                    isActive 
                        ? 'bg-blue-100 border-blue-300 shadow-sm' 
                        : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                }`;
                
                tripItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-gray-800 ${isActive ? 'text-blue-800' : ''}">${trip.name}</p>
                            <p class="text-xs text-gray-500">${tripExpenses.length} ç­†æ”¯å‡º</p>
                            <div class="text-xs text-gray-400 mt-0.5">code: ${trip.id}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${!isActive ? `<button onclick="switchToTrip('${trip.id}')" class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50">åˆ‡æ›</button>` : ''}
                            <button data-copy-code="${trip.id}" class="text-xs text-gray-700 bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded">Copy</button>
                            <button onclick="deleteTrip('${trip.id}')" class="text-xs text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50">åˆªé™¤</button>
                        </div>
                    </div>
                `;
                // Wire copy button
                const copyBtn = tripItem.querySelector('[data-copy-code]');
                if (copyBtn) {
                    copyBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        try {
                            await navigator.clipboard.writeText(trip.id);
                            showMessage('Code copied', 'success');
                        } catch (_) {}
                        const codeBox = document.getElementById('trip-code-input');
                        if (codeBox) codeBox.value = trip.id;
                    });
                }
                tripListEl.appendChild(tripItem);
            });

            // æ›´æ–°ç•¶å‰è¡Œç¨‹é¡¯ç¤º
            const currentTrip = trips.find(t => t.id === currentTripId);
            if (currentTrip) {
                currentTripNameEl.textContent = currentTrip.name;
                const tripExpenses = expenses.filter(exp => exp.tripId === currentTripId);
                currentTripStatsEl.textContent = `${tripExpenses.length} ç­†æ”¯å‡º`;
                console.log('ç•¶å‰è¡Œç¨‹é¡¯ç¤º:', currentTrip.name, 'æ”¯å‡ºæ•¸:', tripExpenses.length);
            } else {
                currentTripNameEl.textContent = 'ç„¡è¡Œç¨‹';
                currentTripStatsEl.textContent = '0 ç­†æ”¯å‡º';
                console.log('æ²’æœ‰æ‰¾åˆ°ç•¶å‰è¡Œç¨‹');
            }

            // æ¸²æŸ“ä¸‹æ‹‰: æ­·å²è¡Œç¨‹
            if (tripSelectEl) {
                tripSelectEl.disabled = false;
                tripSelectEl.innerHTML = '';
                console.log('æ¸²æŸ“è¡Œç¨‹ä¸‹æ‹‰é¸å–®ï¼Œè¡Œç¨‹æ•¸:', trips.length);
                trips.forEach(trip => {
                    const option = document.createElement('option');
                    option.value = trip.id;
                    option.textContent = trip.name;
                    if (trip.id === currentTripId) {
                        option.selected = true;
                        console.log('è¨­å®šç•¶å‰è¡Œç¨‹ç‚ºé¸ä¸­:', trip.name);
                    }
                    tripSelectEl.appendChild(option);
                });
            }
        }

        // --- è‡ªå®šç¾©åˆ†æ”¤é‚è¼¯ ---
        
        /**
         * æ¸²æŸ“è‡ªå®šç¾©åˆ†æ”¤è¼¸å…¥æ¬„ä½
         */
        function renderCustomSplitInputs() {
            customSplitInputs.innerHTML = '';
            customSplitAmounts = {};
            
            if (currentSharers.length === 0) {
                customSplitInputs.innerHTML = '<p class="text-gray-500 text-sm">è«‹å…ˆé¸æ“‡åˆ†æ”¤äºº</p>';
                return;
            }
            
            currentSharers.forEach(member => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex items-center space-x-3';
                inputGroup.innerHTML = `
                    <label class="w-20 text-sm font-medium text-gray-700">${member}</label>
                    <div class="flex-1 flex border border-gray-300 rounded-lg focus-within:ring-blue-500 focus-within:border-blue-500">
                        <span class="p-2 bg-gray-100 rounded-l-lg border-r border-gray-300 text-sm">${expenseCurrencySelect.value}</span>
                        <input type="number" id="split-${member}" placeholder="" min="0" step="1" inputmode="decimal" data-name="${member}"
                               class="flex-1 p-2 rounded-r-lg focus:outline-none appearance-none custom-split-input"
                               onchange="updateCustomSplitAmount('${member}', this.value)">
                    </div>
                    <button onclick="setEqualSplit('${member}')" class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50">
                        å‡åˆ†
                    </button>
                `;
                customSplitInputs.appendChild(inputGroup);
            });
            
            updateSplitTotal();
            // allow typing to immediately update button state (no need to press "apply")
            const inputs = customSplitInputs.querySelectorAll('.custom-split-input');
            inputs.forEach(inp => {
              inp.addEventListener('input', () => {
                const name = inp.getAttribute('data-name') || '';
                updateCustomSplitAmount(name, inp.value);
              });
            });
            inputs.forEach(inp => {
              inp.addEventListener('focus', () => {
                // When moving to 2nd or later fields, if only one empty remains, auto-fill it
                autofillLastEmptyIfApplicable();
              });
            });
        }

        // åˆ‡æ›è‡ªå®šç¾©åˆ†æ”¤æ¨¡å¼ï¼ˆç¼ºé€™å€‹å‡½å¼æœƒé€ æˆå¾ŒçºŒæ‰€æœ‰äº‹ä»¶ç›£è½å™¨ç„¡æ³•è¨»å†Šï¼‰
        function toggleCustomSplitMode() {
            isCustomSplitMode = !isCustomSplitMode;

            if (isCustomSplitMode) {
                customSplitSection.classList.remove('hidden');
                renderCustomSplitInputs();
            } else {
                customSplitSection.classList.add('hidden');
                // é—œé–‰è‡ªå®šç¾©æ¨¡å¼å¾Œï¼Œæ¸…ç©ºæš«å­˜åˆ†æ”¤æ•¸å€¼
                customSplitAmounts = {};
            }
            // ä¾æ–°ç‹€æ…‹æ›´æ–°æ–°å¢æ”¯å‡ºæŒ‰éˆ•å¯ç”¨æ€§
            updateAddExpenseButtonState();
        }

        /**
         * æ›´æ–°è‡ªå®šç¾©åˆ†æ”¤é‡‘é¡
         * @param {string} member æˆå“¡åç¨±
         * @param {string} value é‡‘é¡
         */
        function updateCustomSplitAmount(member, value) {
            const raw = (value != null) ? String(value).trim() : '';
            if (raw === '') {
                // allow empty: remove from map
                delete customSplitAmounts[member];
                updateSplitTotal();
                updateAddExpenseButtonState();
                return;
            }
            const num = parseFloat(raw);
            if (isNaN(num) || num <= 0) {
                // non-positive or NaN should not count
                delete customSplitAmounts[member];
                updateSplitTotal();
                updateAddExpenseButtonState();
                return;
            }
            const newAmount = Math.round(num);
            customSplitAmounts[member] = newAmount;
            // DO NOT auto-compute others here
            updateSplitTotal();
            updateAddExpenseButtonState();
        }

        /**
         * æ™ºèƒ½è¨ˆç®—å‰©é¤˜é‡‘é¡
         */
        function calculateRemainingAmount() {
            const totalAmount = Math.round(parseFloat(expenseAmountInput.value) || 0);
            const enteredAmount = Object.values(customSplitAmounts).reduce((sum, amount) => sum + amount, 0);
            const remainingAmount = totalAmount - enteredAmount;
        }

        /**
         * è¨­å®šå‡åˆ†é‡‘é¡
         * @param {string} member æˆå“¡åç¨±
         */
        function setEqualSplit(member) {
            const totalAmount = Math.round(parseFloat(expenseAmountInput.value) || 0);
            const shareCount = currentSharers.length;
            const equalAmount = shareCount > 0 ? Math.round(totalAmount / shareCount) : 0;
            customSplitAmounts[member] = equalAmount;
            document.getElementById(`split-${member}`).value = String(equalAmount);
            updateSplitTotal();
        }

        /**
         * æ›´æ–°åˆ†æ”¤ç¸½è¨ˆ
         */
        function updateSplitTotal() {
            const total = Object.values(customSplitAmounts).reduce((sum, amount) => sum + amount, 0);
            const expenseAmount = Math.round(parseFloat(expenseAmountInput.value) || 0);
            const difference = Math.abs(total - expenseAmount);
            
            if (expenseAmount > 0) {
                const remaining = expenseAmount - total;
                if (remaining > 0) {
                    splitTotalEl.innerHTML = `ç¸½è¨ˆ: ${formatAmount(total, 0)} ${expenseCurrencySelect.value} <span class="text-orange-600">(å‰©é¤˜: ${formatAmount(remaining, 0)})</span>`;
                } else if (remaining < 0) {
                    splitTotalEl.innerHTML = `ç¸½è¨ˆ: ${formatAmount(total, 0)} ${expenseCurrencySelect.value} <span class="text-red-600">(è¶…å‡º: ${formatAmount(Math.abs(remaining), 0)})</span>`;
                } else {
                    splitTotalEl.innerHTML = `ç¸½è¨ˆ: ${formatAmount(total, 0)} ${expenseCurrencySelect.value}`;
                }
            } else {
                splitTotalEl.textContent = `ç¸½è¨ˆ: ${formatAmount(total, 0)} ${expenseCurrencySelect.value}`;
            }
            
            if (difference === 0) {
                splitTotalEl.classList.remove('text-red-600');
                splitTotalEl.classList.add('text-green-600');
            } else {
                splitTotalEl.classList.remove('text-green-600');
                splitTotalEl.classList.add('text-red-600');
            }
        }

        // ç•¶åªå‰©ä¸€å€‹è‡ªå®šç¾©åˆ†æ”¤è¼¸å…¥ç‚ºç©ºæ™‚ï¼Œè‡ªå‹•å¡«å…¥å‰©é¤˜é‡‘é¡
        function autofillLastEmptyIfApplicable() {
            if (!isCustomSplitMode) return;
            const total = Math.round(parseFloat(expenseAmountInput.value) || 0);
            if (total <= 0) return;
            if (!customSplitInputs) return;

            const inputs = customSplitInputs.querySelectorAll('.custom-split-input');
            let sum = 0;
            const emptyEls = [];
            inputs.forEach(inp => {
                const raw = (inp.value || '').trim();
                if (raw === '') {
                    emptyEls.push(inp);
                } else {
                    const n = parseFloat(raw);
                    if (!isNaN(n)) sum += Math.round(n);
                }
            });

            if (emptyEls.length === 1) {
                const remaining = total - sum;
                if (remaining > 0) {
                    const el = emptyEls[0];
                    el.value = String(Math.round(remaining));
                    const name = el.getAttribute('data-name') || '';
                    updateCustomSplitAmount(name, el.value);
                }
            }
        }

        /**
         * å¥—ç”¨è‡ªå®šç¾©åˆ†æ”¤
         */
        function applyCustomSplit() {
            const totalAmount = Math.round(parseFloat(expenseAmountInput.value) || 0);
            const splitTotal = Object.values(customSplitAmounts).reduce((sum, amount) => sum + amount, 0);
            const difference = Math.abs(splitTotal - totalAmount);
            
            if (difference !== 0) {
                showMessage(`åˆ†æ”¤ç¸½è¨ˆ (${formatAmount(splitTotal, 0)}) èˆ‡æ”¯å‡ºé‡‘é¡ (${formatAmount(totalAmount, 0)}) ä¸ç¬¦ï¼Œè«‹æª¢æŸ¥è¼¸å…¥ã€‚`, 'error');
                return;
            }
            
            const hasZeroAmount = Object.values(customSplitAmounts).some(amount => amount <= 0);
            if (hasZeroAmount) {
                showMessage('æ‰€æœ‰åˆ†æ”¤é‡‘é¡å¿…é ˆå¤§æ–¼é›¶ã€‚', 'error');
                return;
            }
            
            showMessage('è‡ªå®šç¾©åˆ†æ”¤å·²å¥—ç”¨ï¼', 'success');
            updateAddExpenseButtonState();
        }

        // --- ç‹€æ…‹æ›´æ–° & æ¸²æŸ“ ---

        /**
         * æ¸²æŸ“æˆå“¡æ¸…å–®
         */
        function renderMembers() {
            console.log('æ¸²æŸ“æˆå“¡ï¼Œç•¶å‰æˆå“¡æ•¸:', members.length, 'æˆå“¡åˆ—è¡¨:', members);
            memberListEl.innerHTML = members.length > 0 ? '' : '<p class="text-gray-400 text-sm italic">è«‹æ–°å¢æˆå“¡...</p>';
            memberCountEl.textContent = `${members.length} äºº`;
            
            members.forEach(member => {
                const chip = document.createElement('div');
                chip.className = 'chip-base bg-indigo-500 hover:bg-red-600 text-white border-indigo-500';
                chip.innerHTML = `${member} 
                    <button data-member="${member}" class="ml-1 text-xs font-bold opacity-75 hover:opacity-100" onclick="removeMember(event, '${member}')">
                        &times;
                    </button>
                `;
                memberListEl.appendChild(chip);
            });
            
            // ä¿®æ­£/é è¨­åˆ†æ”¤äººç‹€æ…‹ï¼šå¦‚æœæˆå“¡è®Šå‹•ï¼Œä¿®æ­£ currentSharers
            if (members.length > 0) {
                // éæ¿¾æ‰ä¸å­˜åœ¨çš„ sharers
                currentSharers = currentSharers.filter(s => members.includes(s));
                // å¦‚æœæ²’æœ‰åˆ†æ”¤äººï¼Œé è¨­å…¨é¸
                if (currentSharers.length === 0) {
                    currentSharers = [...members];
                }
            } else {
                 currentSharers = [];
            }
            // ä¿®æ­£ currentPayer ç¢ºä¿å…¶ç‚ºæœ‰æ•ˆæˆå“¡
            if (!members.includes(currentPayer)) {
                 currentPayer = members.length > 0 ? members[0] : null; // é è¨­ç¬¬ä¸€å€‹æˆå“¡ä»˜æ¬¾
            }

            console.log('æˆå“¡æ¸²æŸ“å®Œæˆï¼Œä»˜æ¬¾äºº:', currentPayer, 'åˆ†æ”¤äºº:', currentSharers);
            // å„²å­˜è³‡æ–™
            saveAllData(); 
            renderPayerChips();
            renderShareChips();
            calculateAndRenderSettlement();
        }

        /**
         * æ¸²æŸ“ä»˜æ¬¾äººé¸æ“‡æ™¶ç‰‡
         */
        function renderPayerChips() {
            if (members.length === 0) {
                payerChipsEl.innerHTML = '<p class="text-gray-400 text-sm italic p-2">è«‹å…ˆæ–°å¢æˆå“¡</p>';
                addExpenseBtn.disabled = true;
                return;
            }
            
            if (!currentPayer && members.length > 0) {
                currentPayer = members[0];
            }
            
            payerChipsEl.innerHTML = '';
            members.forEach(member => {
                const isActive = member === currentPayer;
                const chip = document.createElement('div');
                chip.className = `chip-base ${isActive ? 'chip-active' : 'chip-inactive hover:bg-gray-200'}`;
                chip.textContent = member;
                chip.onclick = () => selectPayer(member);
                payerChipsEl.appendChild(chip);
            });
            updateAddExpenseButtonState();
        }
        
        /**
         * æ¸²æŸ“åˆ†æ”¤äººé¸æ“‡æ™¶ç‰‡
         */
        function renderShareChips() {
            if (members.length === 0) {
                shareChipsEl.innerHTML = '<p class="text-gray-400 text-sm italic p-2">è«‹å…ˆæ–°å¢æˆå“¡</p>';
                addExpenseBtn.disabled = true;
                customSplitBtn.classList.add('hidden');
                return;
            }
            
            shareChipsEl.innerHTML = '';
            members.forEach(member => {
                const isActive = currentSharers.includes(member);
                const chip = document.createElement('div');
                chip.className = `chip-base ${isActive ? 'chip-active' : 'chip-inactive hover:bg-gray-200'}`;
                chip.textContent = member;
                chip.onclick = () => toggleSharer(member);
                shareChipsEl.appendChild(chip);
            });
            
            // é¡¯ç¤º/éš±è—è‡ªå®šç¾©åˆ†æ”¤æŒ‰éˆ•
            if (currentSharers.length > 0) {
                customSplitBtn.classList.remove('hidden');
            } else {
                customSplitBtn.classList.add('hidden');
                customSplitSection.classList.add('hidden');
                isCustomSplitMode = false;
            }
            
            updateAddExpenseButtonState();
        }

        /**
         * æ¸²æŸ“æ”¯å‡ºæ¸…å–®
         */
        function renderExpenses() {
            expensesListEl.innerHTML = '';
            
            // å¦‚æœæ²’æœ‰ç•¶å‰è¡Œç¨‹ï¼Œé¡¯ç¤ºæç¤º
            if (!currentTripId) {
                expensesListEl.innerHTML = '<li class="text-gray-400 italic text-sm">è«‹å…ˆæ–°å¢è¡Œç¨‹</li>';
                return;
            }
            
            // åªé¡¯ç¤ºç•¶å‰è¡Œç¨‹çš„æ”¯å‡º
            const currentTripExpenses = expenses.filter(exp => exp.tripId === currentTripId);

            // Sort by time ascending so newest ends up at the bottom
            function toTs(v) {
              if (v == null) return 0;
              if (typeof v === 'number') return v;
              const t = Date.parse(v);
              return isNaN(t) ? 0 : t;
            }
            currentTripExpenses.sort((a,b) => toTs(a.createdAt) - toTs(b.createdAt));
            
            if (currentTripExpenses.length === 0) {
                expensesListEl.innerHTML = '<li class="text-gray-400 italic text-sm">å°šç„¡æ”¯å‡ºè¨˜éŒ„...</li>';
                return;
            }

            currentTripExpenses.forEach((expense, index) => {
                const sharersText = expense.sharers.join(', ');
                const listItem = document.createElement('li');
                const twdAmount = convertExpenseToTWD(expense);
                const ts = expense.createdAt ? new Date(expense.createdAt).toLocaleString('zh-TW') : '';

                // ç”Ÿæˆåˆ†æ”¤è©³æƒ…
                let splitDetails = '';
                if (expense.customSplit) {
                    splitDetails = '<p class="text-xs text-blue-600 mt-1">è‡ªå®šç¾©åˆ†æ”¤:</p>';
                    expense.sharers.forEach(sharer => {
                        if (expense.customSplit[sharer]) {
                            splitDetails += `<p class="text-xs text-gray-500 ml-2">${sharer}: ${expense.currency} ${formatAmount(expense.customSplit[sharer])}</p>`;
                        }
                    });
                }

                listItem.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-start space-x-3';
                listItem.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 truncate">${expense.description} 
                           <span class="ml-2 text-xs font-medium text-green-700 bg-green-100 px-2 py-0.5 rounded-full">${expense.category}</span>
                           ${expense.customSplit ? '<span class="ml-1 text-xs font-medium text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full">è‡ªå®šç¾©</span>' : ''}
                        </p>
                        <div class="text-xs text-gray-500">æ™‚é–“: ${ts}</div>
                        <div class="text-xs text-gray-500">ä¾†æºè£ç½®: <span class="font-medium">${expense.createdByDeviceName || (expense.createdByDeviceId ? ('Dev-' + String(expense.createdByDeviceId).slice(-4)) : 'æœªçŸ¥')}</span></div>
                        <p class="text-sm text-gray-500">ä»˜æ¬¾äºº: <span class="font-medium text-indigo-600">${expense.payer}</span></p>
                        <p class="text-xs text-gray-400 truncate">åˆ†æ”¤äºº: ${sharersText}</p>
                        ${splitDetails}
                    </div>
                    <div class="flex-shrink-0 text-right">
                        <p class="text-lg font-bold text-red-600">${expense.currency} ${formatAmount(expense.amount)}</p>
                        <p class="text-xs text-gray-500">(ç´„ TWD ${formatAmount(twdAmount, 0)})</p>
                        <button class="text-xs text-red-400 hover:text-red-600 transition-colors" onclick="removeExpenseById('${expense.id || ''}')">
                            åˆªé™¤
                        </button>
                    </div>
                `;
                expensesListEl.appendChild(listItem);
            });
            calculateAndRenderSettlement();
            saveAllData(); // å„²å­˜è³‡æ–™
        }

        /**
         * æ›´æ–°æ–°å¢æ”¯å‡ºæŒ‰éˆ•çš„ç‹€æ…‹
         */
        function updateAddExpenseButtonState() {
            const amount = parseFloat(expenseAmountInput.value) || 0;
            const description = expenseDescriptionInput.value.trim();
            
            let isReady = amount > 0 && description.length > 0 && currentPayer && currentSharers.length > 0;

            // è‡ªå®šç¾©åˆ†æ”¤æ¨¡å¼ï¼šç›´æ¥è®€å–è¼¸å…¥æ¡†æ•¸å€¼ï¼Œä¸éœ€è¦å…ˆé»ã€Œå¥—ç”¨ã€
            if (isCustomSplitMode && isReady) {
                const map = collectCustomSplitFromInputs();
                const splitTotal = Object.values(map).reduce((sum, v) => sum + v, 0);
                const difference = Math.abs(splitTotal - amount);
                const allPositive = Object.values(map).every(v => v > 0);
                isReady = isReady && Object.keys(map).length === currentSharers.length && difference < 0.01 && allPositive;
            }
            
            addExpenseBtn.disabled = !isReady;
        }

        // ç›´æ¥è’é›†ç›®å‰è‡ªå®šç¾©åˆ†æ”¤è¼¸å…¥å€¼
        function collectCustomSplitFromInputs() {
          const map = {};
          const inputs = document.querySelectorAll('.custom-split-input');
          inputs.forEach(inp => {
            const name = inp.getAttribute('data-name') || inp.name || inp.id || '';
            const val = parseFloat(inp.value);
            if (name && !isNaN(val)) map[name] = val;
          });
          return map;
        }

        /**
         * åˆ‡æ›è¨­å®šå€å¡Šçš„æ”¶åˆç‹€æ…‹
         */
        function toggleSettings() {
            isSettingsOpen = !isSettingsOpen;

            if (isSettingsOpen) {
                // open: allow scrolling area to expand
                settingsContentEl.classList.remove('overflow-hidden');
                settingsContentEl.classList.add('overflow-x-visible');
                settingsContentEl.classList.remove('max-h-0');
                settingsContentEl.classList.add('max-h-[70vh]', 'md:max-h-[80vh]', 'pt-4', 'border-t', 'border-gray-200');
                toggleIconEl.classList.add('rotate-180');
                toggleIconEl.classList.remove('rotate-0');
            } else {
                // close: collapse and remove any height classes
                settingsContentEl.classList.remove('overflow-x-visible');
                settingsContentEl.classList.remove('pt-4', 'border-t', 'border-gray-200', 'max-h-[70vh]', 'md:max-h-[80vh]');
                settingsContentEl.classList.add('max-h-0');
                toggleIconEl.classList.remove('rotate-180');
                toggleIconEl.classList.add('rotate-0');
            }
        }


        // --- æ ¸å¿ƒé‚è¼¯ (è¨ˆç®—) ---

        /**
         * 1. è¨ˆç®—æ¯å€‹æˆå“¡çš„æ·¨é¤˜é¡ (Net Balance)
         * @returns {Map<string, {paid: number, spent: number, net: number}>}
         */
        function calculateBalances() {
            const memberBalances = new Map();
            members.forEach(m => memberBalances.set(m, { paid: 0, spent: 0, net: 0 }));

            // å¦‚æœæ²’æœ‰ç•¶å‰è¡Œç¨‹ï¼Œè¿”å›ç©ºé¤˜é¡
            if (!currentTripId) {
                return memberBalances;
            }

            // åªè¨ˆç®—ç•¶å‰è¡Œç¨‹çš„æ”¯å‡º
            const currentTripExpenses = expenses.filter(exp => exp.tripId === currentTripId);

            currentTripExpenses.forEach(expense => {
                // è½‰æ›ç‚º TWD é€²è¡Œçµç®—
                const rateForExpense = (expense && expense.rateAtCreation != null)
                    ? Number(expense.rateAtCreation) || 0
                    : (exchangeRates[expense.currency] || (expense.currency === 'TWD' ? 1 : 0));
                const amountTWD = Math.round((Number(expense.amount) || 0) * (rateForExpense || 0));
                const sharerCount = expense.sharers.length;
                
                if (sharerCount === 0) return;

                // ç´€éŒ„ä»˜æ¬¾äººå·²ä»˜é‡‘é¡
                if (memberBalances.has(expense.payer)) {
                    memberBalances.get(expense.payer).paid += amountTWD;
                }

                // ç´€éŒ„åˆ†æ”¤äººæ‡‰èŠ±é‡‘é¡
                if (expense.customSplit) {
                    // ä½¿ç”¨è‡ªå®šç¾©åˆ†æ”¤é‡‘é¡
                    expense.sharers.forEach(sharer => {
                        if (memberBalances.has(sharer) && expense.customSplit[sharer]) {
                            const shareAmountTWD = Math.round((Number(expense.customSplit[sharer]) || 0) * (rateForExpense || 0));
                            memberBalances.get(sharer).spent += shareAmountTWD;
                        }
                    });
                } else {
                    // ä½¿ç”¨å‡åˆ†
                    const sharePerPerson = amountTWD / sharerCount;
                    expense.sharers.forEach(sharer => {
                        if (memberBalances.has(sharer)) {
                            memberBalances.get(sharer).spent += sharePerPerson;
                        }
                    });
                }
            });

            // è¨ˆç®—æ·¨é¤˜é¡ (Net)
            memberBalances.forEach((data, member) => {
                data.net = data.paid - data.spent;
            });

            return memberBalances;
        }

        /**
         * 2. ç°¡åŒ–å‚µå‹™ (æ¸…ç®—è·¯å¾‘)
         */
        function simplifyDebts(memberBalances) {
            const people = Array.from(memberBalances.keys());
            const netBalances = people.map(p => ({
                name: p,
                // é€™è£¡å¿…é ˆä½¿ç”¨åŸå§‹çš„æµ®é»æ•¸é¤˜é¡é€²è¡Œè¨ˆç®—
                amount: memberBalances.get(p).net
            }));

            const creditors = netBalances.filter(p => p.amount > 0); 
            const debtors = netBalances.filter(p => p.amount < 0);   
            
            const settlements = [];
            const tolerance = 0.5; // å°æ–¼ 0.5 TWD çš„å‚µå‹™å¿½ç•¥

            // å°‡æµ®é»æ•¸é™£åˆ—è¤‡è£½ä¸¦æ’åºï¼Œä»¥ä¾¿å„ªå…ˆè™•ç†æœ€å¤§å‚µå‹™/å‚µæ¬Š
            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => a.amount - b.amount); // amount æ˜¯è² æ•¸ï¼Œæ‰€ä»¥å¾å°åˆ°å¤§æ˜¯çµ•å°å€¼å¾å¤§åˆ°å°

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                
                // äº¤æ˜“é‡‘é¡å–å…©è€…ä¹‹é–“è¼ƒå°è€… (çµ•å°å€¼)
                const paymentAmount = Math.min(creditor.amount, Math.abs(debtor.amount));

                // è¨˜éŒ„äº¤æ˜“
                if (paymentAmount >= tolerance) {
                    settlements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: paymentAmount
                    });
                }
                
                // æ›´æ–°é¤˜é¡
                debtor.amount += paymentAmount; 
                creditor.amount -= paymentAmount;
                
                // ç§»é™¤å·²çµæ¸…çš„æˆå“¡
                if (Math.abs(debtor.amount) < tolerance) {
                    i++; // æ›ä¸‹ä¸€å€‹å‚µå‹™äºº
                }
                if (creditor.amount < tolerance) {
                    j++; // æ›ä¸‹ä¸€å€‹å‚µæ¬Šäºº
                }
            }
            
            return settlements;
        }

        /**
         * 3. åŸ·è¡Œè¨ˆç®—ä¸¦æ¸²æŸ“çµç®—ç¸½è¦½å’Œè·¯å¾‘
         */
        function calculateAndRenderSettlement() {
            if (members.length === 0 || !currentTripId) {
                 settlementListEl.innerHTML = '<p class="text-indigo-300 text-sm text-center">è«‹æ–°å¢æˆå“¡èˆ‡è¡Œç¨‹ä¾†è¨ˆç®—</p>';
                 settlementPathEl.innerHTML = '<p class="text-gray-400 text-sm text-center">æ¸…ç®—è·¯å¾‘æœƒåœ¨é€™è£¡é¡¯ç¤º</p>';
                 return;
            }

            const memberBalances = calculateBalances();
            // compute and render trip total (TWD)
            let tripTotalTWD = 0;
            const currentTripExpenses = expenses.filter(exp => exp.tripId === currentTripId);
            currentTripExpenses.forEach(exp => {
              tripTotalTWD += convertExpenseToTWD(exp);
            });
            const totalEl = document.getElementById('trip-total-twd');
            if (totalEl) totalEl.textContent = formatAmount(Math.round(tripTotalTWD), 0);
            const totalLabel = document.getElementById('trip-total-label');
            if (totalLabel) {
              const t = trips.find(x => x.id === currentTripId);
              totalLabel.textContent = (t ? t.name : 'æ­¤è¡Œç¨‹') + 'ç¸½èŠ±è²» (TWD):';
            }

            // render per-member should-spend chips
            const badgesEl = document.getElementById('should-spend-badges');
            if (badgesEl) {
              badgesEl.innerHTML = '';
              const entries = Array.from(memberBalances.entries());
              entries.forEach(([member, data]) => {
                const val = Math.round(data.spent || 0);
                const chip = document.createElement('span');
                chip.className = 'inline-flex items-center px-3 py-1 rounded-full bg-indigo-600 text-sm';
                chip.textContent = member + ': ' + formatAmount(val, 0);
                badgesEl.appendChild(chip);
              });
            }

            // 5. æ¸²æŸ“çµç®—ç¸½è¦½
            settlementListEl.innerHTML = '';
            memberBalances.forEach((balanceData, member) => {
                const status = balanceData.net;
                let statusText;
                let statusClass;

                // æ·¨é¤˜é¡å››æ¨äº”å…¥åˆ°æ•´æ•¸ä½ï¼Œç”¨æ–¼é¡¯ç¤º
                const roundedStatus = Math.round(status);
                const paidRounded = Math.round(balanceData.paid);
                const spentRounded = Math.round(balanceData.spent);

                if (Math.abs(status) < 0.5) { // ä½¿ç”¨ 0.5 TWD å®¹å¿åº¦
                    statusText = 'å¹³è¡¡';
                    statusClass = 'bg-gray-400 text-white';
                } else if (status > 0) {
                    statusText = `æ‡‰æ”¶ ${formatAmount(roundedStatus, 0)}`;
                    statusClass = 'bg-green-500 text-white';
                } else {
                    statusText = `æ‡‰ä»˜ ${formatAmount(Math.abs(roundedStatus), 0)}`;
                    statusClass = 'bg-red-500 text-white';
                }

                const memberItem = document.createElement('div');
                memberItem.className = 'grid grid-cols-4 text-sm';
                memberItem.innerHTML = `
                    <span class="font-medium text-indigo-100">${member}</span>
                    <div class="text-center text-indigo-200">${formatAmount(paidRounded, 0)}</div>
                    <div class="text-center text-indigo-200">${formatAmount(spentRounded, 0)}</div>
                    <div class="text-center font-bold ${statusClass} p-1 rounded">
                        ${statusText}
                    </div>
                `;
                settlementListEl.appendChild(memberItem);
            });
            
            // 6. æ¸²æŸ“æœ€ä½³æ¸…ç®—è·¯å¾‘
            const settlements = simplifyDebts(memberBalances);
            settlementPathEl.innerHTML = '';

            if (settlements.length === 0) {
                 settlementPathEl.innerHTML = '<p class="text-center text-gray-400">ç›®å‰ç„¡éœ€çµç®—æˆ–çµç®—é‡‘é¡éå°ã€‚</p>';
            } else {
                settlements.forEach(s => {
                    const item = document.createElement('div');
                    // æ¸…ç®—è·¯å¾‘çš„é‡‘é¡ä¹Ÿå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼Œè®“ä½¿ç”¨è€…æ›´å®¹æ˜“æ”¯ä»˜
                    const roundedAmount = Math.round(s.amount); 
                    item.className = 'flex items-center justify-center p-2 bg-indigo-500 rounded-lg font-semibold text-sm shadow-md';
                    item.innerHTML = `
                        <span class="text-yellow-300 mr-2">${s.from}</span>
                        <span class="text-white">æ‡‰ä»˜ <span class="text-lg">${formatAmount(roundedAmount, 0)}</span> TWD çµ¦</span>
                        <span class="text-green-300 ml-2">${s.to}</span>
                    `;
                    settlementPathEl.appendChild(item);
                });
            }
        }


        // --- äº‹ä»¶è™•ç†å™¨ ---

        /**
         * æ–°å¢æˆå“¡
         */
        function addMember() {
            const name = memberNameInput.value.trim();
            if (name.length > 0 && !members.includes(name)) {
                members.push(name);
                markTripEdited(currentTripId);
                memberNameInput.value = '';
                // æ–°å¢æˆå“¡å¾Œï¼Œè®“åˆ†æ”¤äººé è¨­å…¨é¸
                currentSharers = [...members]; 
                renderMembers();
            } else if (name.length > 0) {
                showMessage(`æˆå“¡ ${name} å·²å­˜åœ¨ã€‚`, 'warning');
            } else {
                 showMessage('æˆå“¡åç¨±ä¸èƒ½ç‚ºç©ºã€‚', 'warning');
            }
        }
        
        /**
         * ç§»é™¤æˆå“¡
         */
        function removeMember(event, memberName) {
            event.stopPropagation();
            
            // æª¢æŸ¥è©²æˆå“¡æ˜¯å¦æœ‰ç›¸é—œçš„æ”¯å‡ºè¨˜éŒ„
            const relatedExpenses = expenses.filter(exp => 
                exp.tripId === currentTripId && (exp.payer === memberName || exp.sharers.includes(memberName))
            );
            
            if (relatedExpenses.length > 0) {
                // æœ‰ç›¸é—œæ”¯å‡ºï¼Œé¡¯ç¤ºç¢ºèªå°è©±æ¡†
                showConfirmDialog(memberName, relatedExpenses.length);
            } else {
                // æ²’æœ‰ç›¸é—œæ”¯å‡ºï¼Œç›´æ¥åˆªé™¤
                executeRemoveMember(memberName, false);
            }
        }

        /**
         * åŸ·è¡Œå¯¦éš›çš„æˆå“¡åˆªé™¤æ“ä½œ
         * @param {string} memberName è¦åˆªé™¤çš„æˆå“¡åç¨±
         * @param {boolean} removeRelatedExpenses æ˜¯å¦åˆªé™¤ç›¸é—œæ”¯å‡ºè¨˜éŒ„
         */
        function executeRemoveMember(memberName, removeRelatedExpenses) {
            // 1. ç§»é™¤æˆå“¡
            members = members.filter(m => m !== memberName);
            
            if (removeRelatedExpenses) {
                // 2a. åˆªé™¤æ‰€æœ‰ç›¸é—œæ”¯å‡ºè¨˜éŒ„
                expenses = expenses.filter(exp => 
                    exp.payer !== memberName && !exp.sharers.includes(memberName)
                );
            } else {
                // 2b. ä¿ç•™æ”¯å‡ºè¨˜éŒ„ï¼Œä½†è™•ç†è©²æˆå“¡çš„åƒèˆ‡
                expenses = expenses.map(exp => {
                    // ç§»é™¤åˆ†æ”¤äºº
                    exp.sharers = exp.sharers.filter(s => s !== memberName);
                    
                    // å¦‚æœä»˜æ¬¾äººæ˜¯è©²æˆå“¡ï¼Œæ”¹ç‚ºç¬¬ä¸€å€‹å¯ç”¨æˆå“¡
                    if (exp.payer === memberName && exp.sharers.length > 0) {
                        exp.payer = exp.sharers[0];
                    }
                    
                    return exp;
                }).filter(exp => 
                    // å¦‚æœä»˜æ¬¾äººè¢«ç§»é™¤ä¸”æ²’æœ‰åˆ†æ”¤äººï¼Œå‰‡ç§»é™¤è©²æ”¯å‡ºè¨˜éŒ„
                    exp.payer !== memberName && exp.sharers.length > 0
                );
            }
            
            // 3. ç§»é™¤ä»˜æ¬¾äººå’Œåˆ†æ”¤äººç‹€æ…‹ä¸­çš„è©²æˆå“¡
            if (currentPayer === memberName) currentPayer = members.length > 0 ? members[0] : null;
            currentSharers = currentSharers.filter(s => s !== memberName);

            // 4. é‡æ–°æ¸²æŸ“æ‰€æœ‰ç›¸é—œå…ƒç´ ä¸¦å„²å­˜
            renderMembers();
            renderExpenses();
            renderTrips(); // â¬…ï¸ æ–°å¢é€™è¡Œï¼šç•¶æ”¯å‡ºè¢«ç§»é™¤æˆ–è®Šå‹•æ™‚ï¼Œæ›´æ–°å„è¡Œç¨‹ç­†æ•¸
            calculateAndRenderSettlement();
            markTripEdited(currentTripId);
            saveAllData();
            
            // 5. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const action = removeRelatedExpenses ? 'ä¸¦åˆªé™¤ç›¸é—œæ”¯å‡ºè¨˜éŒ„' : 'ï¼ˆä¿ç•™æ”¯å‡ºè¨˜éŒ„ï¼‰';
            showMessage(`æˆå“¡ "${memberName}" å·²åˆªé™¤${action}`, 'success');
            
            // 6. éš±è—ç¢ºèªå°è©±æ¡†
            hideConfirmDialog();
        }

        /**
         * é¸æ“‡ä»˜æ¬¾äºº
         */
        function selectPayer(member) {
            currentPayer = member;
            renderPayerChips();
            updateAddExpenseButtonState();
        }

        /**
         * åˆ‡æ›åˆ†æ”¤äººç‹€æ…‹
         */
        function toggleSharer(member) {
            const index = currentSharers.indexOf(member);
            if (index > -1) {
                currentSharers.splice(index, 1);
            } else {
                currentSharers.push(member);
            }
            renderShareChips();
            updateAddExpenseButtonState();
        }
        
        /**
         * åˆ‡æ›å…¨é¸/å–æ¶ˆå…¨é¸åˆ†æ”¤äºº
         */
        function toggleSelectAllSharers() {
            if (members.length === 0) {
                showMessage('è«‹å…ˆæ–°å¢æˆå“¡æ‰èƒ½é¸æ“‡åˆ†æ”¤äººã€‚', 'warning');
                return;
            }
            
            if (currentSharers.length === members.length) {
                // å–æ¶ˆå…¨é¸
                currentSharers = [];
            } else {
                // å…¨é¸
                currentSharers = [...members];
            }
            renderShareChips();
            updateAddExpenseButtonState();
        }

        /**
         * æ–°å¢æ”¯å‡º
         */
        async function addExpense() {
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const currency = expenseCurrencySelect.value;

            if (!currentTripId) { showMessage('è«‹å…ˆæ–°å¢è¡Œç¨‹ã€‚', 'error'); return; }
            if (!currentPayer) { showMessage('è«‹é¸æ“‡ä»˜æ¬¾äººã€‚', 'error'); return; }
            if (currentSharers.length === 0) { showMessage('è«‹é¸æ“‡åˆ†æ”¤äººã€‚', 'error'); return; }
            if (amount <= 0 || isNaN(amount)) { showMessage('é‡‘é¡å¿…é ˆå¤§æ–¼é›¶ã€‚', 'error'); return; }
            if (description.length === 0) { showMessage('è«‹è¼¸å…¥æ”¯å‡ºæè¿°ã€‚', 'error'); return; }
            if (!exchangeRates[currency] && currency !== 'TWD') { 
                showMessage(`è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ ${currency} çš„åŒ¯ç‡ã€‚`, 'error'); 
                return;
            }

            const newExpense = {
                description,
                amount,
                currency, 
                category: currentCategory, 
                payer: currentPayer,
                sharers: [...currentSharers], // è¤‡è£½é™£åˆ—
                tripId: currentTripId, // æ·»åŠ è¡Œç¨‹ ID
                createdAt: new Date().toISOString(),
                // æ·»åŠ è‡ªå®šç¾©åˆ†æ”¤è³‡è¨Š
                customSplit: isCustomSplitMode ? { ...customSplitAmounts } : null
            };

            // tag device info
            newExpense.createdByDeviceId = DEVICE && DEVICE.id ? DEVICE.id : '';
            newExpense.createdByDeviceName = DEVICE && DEVICE.name ? DEVICE.name : '';

            // è‹¥å•Ÿç”¨è‡ªå®šç¾©åˆ†æ”¤ï¼Œç›´æ¥è®€å–è¼¸å…¥å€¼è¦†è“‹ customSplit
            if (isCustomSplitMode) {
                const map = collectCustomSplitFromInputs();
                if (Object.keys(map).length > 0) {
                    newExpense.customSplit = map;
                }
            }

            // ç¢ºä¿å­˜åœ¨å»ºç«‹æ™‚é–“ (ISO å­—ä¸²ï¼Œä¾¿æ–¼æ’åº)
            newExpense.createdAt = new Date().toISOString();

            // æ–¼å»ºç«‹æ™‚ä¿å­˜åŒ¯ç‡ï¼Œé¿å…ä¹‹å¾Œåˆ·æ–°å½±éŸ¿èˆŠè³‡æ–™ï¼ˆè‹¥ç„¡å‰‡ä»¥ 1 ä½œç‚ºä¿éšªå€¼ï¼‰
            newExpense.rateAtCreation = (exchangeRates && exchangeRates[newExpense.currency] != null)
                ? exchangeRates[newExpense.currency]
                : 1;

            // If cloud-linked, write-through to Firestore first, and DO NOT push locally (avoid duplicate)
            if (syncedTripId && db) {
              try {
                const expRef = db.collection('trips').doc(syncedTripId).collection('expenses');
                const newId = db.collection('_').doc().id; // pre-generate id
                newExpense.id = newId;
                const payload = Object.assign({}, newExpense, {
                  updatedAt: new Date().toISOString(),
                  updatedBy: (DEVICE && DEVICE.name) ? DEVICE.name : 'web'
                });
                await expRef.doc(newId).set(payload, { merge: true });

                // Clear UI and exit â€” let onSnapshot render it back, preventing duplicates
                isCustomSplitMode = false;
                if (typeof customSplitSection !== 'undefined' && customSplitSection) customSplitSection.classList.add('hidden');
                if (typeof customSplitInputs !== 'undefined' && customSplitInputs) customSplitInputs.innerHTML = '';
                if (typeof customSplitAmounts !== 'undefined') customSplitAmounts = {};
                markTripEdited(currentTripId);
                if (typeof expenseDescriptionInput !== 'undefined' && expenseDescriptionInput) expenseDescriptionInput.value = '';
                if (typeof expenseAmountInput !== 'undefined' && expenseAmountInput) expenseAmountInput.value = '';
                if (Array.isArray(members)) currentSharers = [...members];
                if (typeof renderPayerChips === 'function') renderPayerChips();
                if (typeof renderShareChips === 'function') renderShareChips();
                if (typeof updateAddExpenseButtonState === 'function') updateAddExpenseButtonState();
                // Ensure we are actually subscribed (in case auto-resume hasn't attached yet)
                try {
                  if (!unsubscribeCloud && syncedTripId) {
                    if (!db) db = await ensureDbReady();
                    await subscribeTrip(syncedTripId);
                  }
                } catch (e) {
                  console.warn('subscribe after write-through failed:', e);
                }
                try { ensureViewingSyncedTrip(); } catch(_) {}
                showMessage('æˆåŠŸæ–°å¢æ”¯å‡ºï¼ï¼ˆå·²é›²ç«¯å¯«å…¥ï¼Œç¨å¾Œè‡ªå‹•é¡¯ç¤ºï¼‰', 'success');
                return; // IMPORTANT: stop here to avoid local push
              } catch (e) {
                console.error('Cloud write-through failed, fallback to local only:', e);
                // If cloud write fails, fall back to local push below
              }
            }

            // Local-only path (when not cloud-linked OR cloud write failed)
            expenses.push(newExpense);
            // Ensure subsequent save mirrors to cloud (do not skip due to a recent hydrate)
            justHydratedFromCloud = false;
            /* reset custom split state after a successful add */
            isCustomSplitMode = false;
            customSplitSection.classList.add('hidden');
            customSplitAmounts = {};
            if (customSplitInputs) customSplitInputs.innerHTML = '';
            console.log('æ–°å¢æ”¯å‡ºæˆåŠŸ:', newExpense);
            markTripEdited(currentTripId);
            // æ¸…ç©ºè¼¸å…¥
            expenseDescriptionInput.value = '';
            expenseAmountInput.value = '';
            // é‡è¨­åˆ†æ”¤äººç‚ºå…¨é¸ç‹€æ…‹ (ä¾æ“šéœ€æ±‚)
            currentSharers = [...members]; 

            // é‡æ–°æ¸²æŸ“ä¸¦å„²å­˜
            renderPayerChips(); // ä»˜æ¬¾äººä¿æŒä¸è®Š
            renderShareChips(); 
            renderExpenses();
            renderTrips(); // â¬…ï¸ æ–°å¢é€™è¡Œï¼šåŒæ­¥æ›´æ–°ã€Œç•¶å‰è¡Œç¨‹ã€èˆ‡æ­·å²è¡Œç¨‹ä¸‹æ‹‰çš„ç­†æ•¸
            updateAddExpenseButtonState();
            saveAllData();
            showMessage('æˆåŠŸæ–°å¢æ”¯å‡ºï¼', 'success');
            if (syncedTripId) console.log('[Cloud] write-through added expense id:', newExpense.id, 'to trip:', syncedTripId);
        }

        // Real-time delete by id (write-through to Firestore)
        async function removeExpenseById(id) {
          try {
            const idx = expenses.findIndex(e => e.id === id && e.tripId === currentTripId);
            if (idx === -1) {
              console.warn('removeExpenseById: local expense not found for id:', id);
            }
            if (syncedTripId && db && id) {
              const ref = db.collection('trips').doc(syncedTripId).collection('expenses').doc(id);
              try { await ref.delete(); } catch (e) { console.error('Cloud delete failed, will still remove locally:', e); }
            }
            expenses = expenses.filter(e => !(e.id === id && e.tripId === currentTripId));
            renderExpenses();
            renderTrips();
            calculateAndRenderSettlement();
            saveAllData();
            showMessage('æ”¯å‡ºè¨˜éŒ„å·²åˆªé™¤ã€‚', 'success');
          } catch (e) {
            console.error('removeExpenseById failed:', e);
            showMessage('åˆªé™¤å¤±æ•—ï¼š' + (e.message || ''), 'error');
          }
        }
        
        /**
         * ç§»é™¤æ”¯å‡º
         */
        function removeExpense(index) {
            if (index >= 0 && index < expenses.length) {
                const exp = expenses[index];
                if (exp && exp.id) return removeExpenseById(exp.id);
                // No id (legacy local-only)
                expenses.splice(index, 1);
                renderExpenses();
                renderTrips();
                calculateAndRenderSettlement();
                saveAllData();
                showMessage('æ”¯å‡ºè¨˜éŒ„å·²åˆªé™¤ã€‚', 'success');
            }
        }


        // --- å•Ÿå‹•èˆ‡äº‹ä»¶ç›£è½ (åŒ…è£¹åœ¨ DOMContentLoaded ç¢ºä¿åˆå§‹åŒ–æˆåŠŸ) ---
        document.addEventListener('DOMContentLoaded', () => {
            DEVICE = ensureDeviceIdentity();
            // 1. DOM å…ƒç´ åˆå§‹åŒ–
            memberNameInput = document.getElementById('member-name-input');
            addMemberBtn = document.getElementById('add-member-btn');
            memberListEl = document.getElementById('member-list');
            memberCountEl = document.getElementById('member-count');

            expenseDescriptionInput = document.getElementById('expense-description');
            expenseAmountInput = document.getElementById('expense-amount');
            expenseCurrencySelect = document.getElementById('expense-currency'); 
            categoryChipsEl = document.getElementById('category-chips'); 

            payerChipsEl = document.getElementById('payer-chips');
            shareChipsEl = document.getElementById('share-chips');
            selectAllSharersBtn = document.getElementById('select-all-sharers');
            addExpenseBtn = document.getElementById('add-expense-btn');

            expensesListEl = document.getElementById('expenses-list');
            settlementListEl = document.getElementById('settlement-list');
            settlementPathEl = document.getElementById('settlement-path');
            
            exchangeRateInputsEl = document.getElementById('exchange-rate-inputs'); 
            // ç§»é™¤äº† fetchRatesBtn
            rateLastUpdatedEl = document.getElementById('rate-last-updated'); 
            messageBoxEl = document.getElementById('message-box');
            messageContentEl = document.getElementById('message-content');

            settingsContentEl = document.getElementById('settings-content');
            toggleSettingsBtn = document.getElementById('toggle-settings-btn');
            toggleIconEl = document.getElementById('toggle-icon');

            // ç¢ºèªå°è©±æ¡†å…ƒç´ 
            confirmDialogEl = document.getElementById('confirm-dialog');
            confirmTitleEl = document.getElementById('confirm-title');
            confirmMessageEl = document.getElementById('confirm-message');
            confirmCancelBtn = document.getElementById('confirm-cancel');
            confirmKeepExpensesBtn = document.getElementById('confirm-keep-expenses');
            confirmDeleteExpensesBtn = document.getElementById('confirm-delete-expenses');

            // è¡Œç¨‹ç®¡ç†å…ƒç´ 
            tripNameInput = document.getElementById('trip-name-input');
            addTripBtn = document.getElementById('add-trip-btn');
            tripListEl = document.getElementById('trip-list');
            currentTripNameEl = document.getElementById('current-trip-name');
            currentTripStatsEl = document.getElementById('current-trip-stats');
            tripSelectEl = document.getElementById('trip-select');


            // è‡ªå®šç¾©åˆ†æ”¤å…ƒç´ 
            customSplitBtn = document.getElementById('custom-split-btn');
            customSplitSection = document.getElementById('custom-split-section');
            customSplitInputs = document.getElementById('custom-split-inputs');
            splitTotalEl = document.getElementById('split-total');
            applyCustomSplitBtn = document.getElementById('apply-custom-split');

            // 2. è¼‰å…¥ Local Storage è³‡æ–™
            loadAllData();

            /* keep settings collapsed by default; user can open via header button */
            isSettingsOpen = false;
            settingsContentEl.classList.remove('max-h-[70vh]', 'md:max-h-[80vh]', 'pt-4', 'border-t', 'border-gray-200');
            settingsContentEl.classList.add('max-h-0');
            toggleIconEl.classList.remove('rotate-180');
            toggleIconEl.classList.add('rotate-0');

            /* 2.2 å¼·åˆ¶åˆ‡åˆ°ã€Œæœ€å¾Œä¸€æ¬¡ç·¨è¼¯/ç•¶å‰è¡Œç¨‹ã€ï¼ŒåŒæ­¥é¡¯ç¤ºä»˜æ¬¾äººã€åˆ†æ”¤äººã€æ”¯å‡ºèˆ‡æ­·å²è¡Œç¨‹ */
            if (currentTripId && trips.some(t => t.id === currentTripId)) {
              switchToTrip(currentTripId);
            } else if (trips.length > 0) {
              switchToTrip(trips[0].id);
            }
            updateHeaderTripName();

            // 3. è¨­ç½®äº‹ä»¶ç›£è½å™¨
            addMemberBtn.addEventListener('click', addMember);
            memberNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addMember();
            });
            
            addExpenseBtn.addEventListener('click', addExpense);
            selectAllSharersBtn.addEventListener('click', toggleSelectAllSharers); 
            // ç§»é™¤äº† fetchRatesBtn.addEventListener('click', fetchRatesFromAPI);
            
            toggleSettingsBtn.addEventListener('click', toggleSettings); 

            expenseAmountInput.addEventListener('input', updateAddExpenseButtonState);
            expenseDescriptionInput.addEventListener('input', updateAddExpenseButtonState);
            expenseCurrencySelect.addEventListener('change', updateAddExpenseButtonState);

            // è¡Œç¨‹ç®¡ç†äº‹ä»¶ç›£è½å™¨
            addTripBtn.addEventListener('click', addTrip);
            tripNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTrip();
            });
            tripSelectEl.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                if (selectedId) switchToTrip(selectedId);
            });

            // åŒ¯å‡ºäº‹ä»¶ï¼ˆExcelï¼‰
            const exportExcelBtn = document.getElementById('export-excel-btn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', exportTripToExcel);
            }

            // åŒ¯ç‡åˆ·æ–°æŒ‰éˆ•
            const refreshRatesBtn = document.getElementById('refresh-rates-btn');
            if (refreshRatesBtn) {
                refreshRatesBtn.addEventListener('click', () => {
                    const baseSel = document.getElementById('base-currency-select');
                    const base = baseSel && baseSel.value ? baseSel.value : 'TWD';
                    fetchLiveRates(base);
                });
            }
            const addCurrencyBtn = document.getElementById('add-currency-btn');
            if (addCurrencyBtn) addCurrencyBtn.addEventListener('click', addCurrency);
            const ratesTsEl = document.getElementById('rates-updated-at');
            if (ratesTsEl) {
                const ts = getStoredRateUpdatedAt();
                if (ts) ratesTsEl.textContent = 'Updated: ' + new Date(ts).toLocaleString('zh-TW');
            }

            // Auto resume cloud sync without pressing "Link"
            autoResumeCloudOnLoad();

            // Re-attach subscription when window regains focus (mobile helpful)
            window.addEventListener('focus', async () => {
              try {
                const code = getSyncedId();
                if (looksLikeTripCode(code)) {
                  if (!db) db = await ensureDbReady();
                  if (syncedTripId !== code) { syncedTripId = code; setCloudStatus('å·²åŒæ­¥ï¼š' + code); }
                  await subscribeTrip(code);
                }
              } catch (e) { console.warn('auto-resubscribe on focus failed:', e); }
            });

            // é›²ç«¯åŒæ­¥æ§åˆ¶å…ƒä»¶ (Link / Cancel)
            const codeInput = document.getElementById('trip-code-input');
            const btnLink = document.getElementById('cloud-link');
            const btnCancel = document.getElementById('cloud-cancel');

            // --- Auto-link on input (debounced) and on Enter ---
            let codeDebounce = null;

            if (codeInput) {
              codeInput.addEventListener('input', () => {
                const v = codeInput.value.trim();
                window.clearTimeout(codeDebounce);
                if (looksLikeTripCode(v)) {
                  codeDebounce = setTimeout(() => { linkToTripCode(v); }, 700);
                }
              });
              codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                  const v = codeInput.value.trim();
                  if (looksLikeTripCode(v)) linkToTripCode(v);
                }
              });
            }

            if (btnLink) btnLink.addEventListener('click', async () => {
              const v = (codeInput && codeInput.value || '').trim();
              if (!looksLikeTripCode(v)) return;
              try { btnLink.disabled = true; await linkToTripCode(v); }
              finally { btnLink.disabled = false; }
            });
            if (btnCancel) btnCancel.addEventListener('click', () => {
              showConfirmDialogGeneric(
                'å–æ¶ˆåŒæ­¥ç¢ºèª',
                'å–æ¶ˆåŒæ­¥å¾Œï¼Œä½ çš„ç•«é¢æœƒç«‹å³è¤‡è£½ç‚ºä¸€å€‹æ–°çš„æœ¬æ©Ÿè¡Œç¨‹ï¼Œä¸¦åœæ­¢æ¥æ”¶ä»–äººè®Šæ›´ã€‚',
                null,
                () => { cancelSync(); }
              );
              const keepBtn = document.getElementById('confirm-keep-expenses');
              const delBtn = document.getElementById('confirm-delete-expenses');
              if (keepBtn) keepBtn.textContent = 'å…ˆä¸è¦';
              if (delBtn) delBtn.textContent = 'å–æ¶ˆåŒæ­¥';
            });

            // è‡ªå®šç¾©åˆ†æ”¤äº‹ä»¶ç›£è½å™¨
            customSplitBtn.addEventListener('click', toggleCustomSplitMode);
            applyCustomSplitBtn.addEventListener('click', applyCustomSplit);
            expenseAmountInput.addEventListener('input', () => {
                if (isCustomSplitMode) {
                    updateSplitTotal();
                    autofillLastEmptyIfApplicable();
                }
            });
            expenseCurrencySelect.addEventListener('change', () => {
                if (isCustomSplitMode) {
                    renderCustomSplitInputs();
                }
            });

            // ç¢ºèªå°è©±æ¡†äº‹ä»¶ç›£è½å™¨
            confirmCancelBtn.addEventListener('click', hideConfirmDialog);
            confirmKeepExpensesBtn.addEventListener('click', () => {
                if (typeof confirmKeepHandler === 'function') {
                    const fn = confirmKeepHandler; // é˜²æ­¢é‡å…¥
                    confirmKeepHandler = null; confirmDeleteHandler = null;
                    fn();
                } else if (pendingMemberName) {
                    executeRemoveMember(pendingMemberName, false);
                }
            });
            confirmDeleteExpensesBtn.addEventListener('click', () => {
                if (typeof confirmDeleteHandler === 'function') {
                    const fn = confirmDeleteHandler; // é˜²æ­¢é‡å…¥
                    confirmKeepHandler = null; confirmDeleteHandler = null;
                    fn();
                } else if (pendingMemberName) {
                    executeRemoveMember(pendingMemberName, true);
                }
            });

            // 4. åˆå§‹åŒ–æ¸²æŸ“ï¼šç¢ºä¿æ‰€æœ‰å€å¡Šæ­£ç¢ºé¡¯ç¤º
            renderCategoryChips(); 
            renderExchangeRateInputs(); 
            // Optional: stamp missing rateAtCreation for old expenses once
            backfillRateAtCreationIfMissing();
            
            // å¼·åˆ¶æ¸²æŸ“æ‰€æœ‰å€å¡Šï¼Œç¢ºä¿ç•«é¢é¡¯ç¤ºæ­£ç¢º
            renderTrips();
            renderMembers();
            renderPayerChips();
            renderShareChips();
            renderExpenses();
            calculateAndRenderSettlement();
            updateAddExpenseButtonState();

            // å‹•æ…‹æ›´æ–°æ¨™é¡Œå‰¯æ¨™ç¤ºç›®å‰è¡Œç¨‹åç¨±
            updateHeaderTripName();

            console.log('åˆå§‹åŒ–å®Œæˆï¼Œç•¶å‰ç‹€æ…‹:', {
                trips: trips.length,
                currentTripId: currentTripId,
                members: members.length,
                expenses: expenses.length
            });
        });
        
    </script>
</body>
</html>
